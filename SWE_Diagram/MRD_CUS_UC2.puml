@startuml
title "MRD-CUS-UC2: 메뉴 탐색 및 주문 (Customer: Browse and Place Order) 교류도"

actor "고객 (Customer)" as C
participant "Client App\n(Next.js)" as App
participant "API Gateway\n(FastAPI)" as GW

' -- 백엔드 마이크로서비스 --
participant "Menu & Inv. Service" as MenuSvc
database "ProductDB\n(Product Schema)" as PDB
participant "CRM & Discount Service" as CrmSvc
database "UserDB\n(User Schema)" as UDB
database "CrmDB\n(CRM Schema)" as CDB
participant "Order Service" as OrderSvc
participant "Payment Service" as PaySvc
participant "External PG" as PG
database "OrderDB\n(Order Schema)" as ODB

' -- 알림 수신자 --
participant "Admin App\n(Dashboard)" as Admin

skinparam ParticipantPadding 20
skinparam BoxPadding 10

' --- 1. (주 흐름 1) 메뉴 탐색 ---
group (1) 메뉴 탐색 (Browse Menu)
    C -> App: 메뉴 페이지 접근
    activate App
    App -> GW: (1) GET /menu
    activate GW
    GW -> MenuSvc: (라우팅) get_public_menu_list()
    activate MenuSvc
    MenuSvc -> PDB: (SQL) SELECT * FROM products
    activate PDB
    PDB --> MenuSvc: 메뉴 목록
    deactivate PDB
    MenuSvc --> GW: 메뉴 목록 (JSON)
    deactivate MenuSvc
    GW --> App: 메뉴 목록 (JSON)
    deactivate GW
    App --> C: 메뉴 UI 렌더링
    deactivate App
end

' --- 2. (주 흐름 3) 장바구니 추가 ---
group (2) 장바구니 추가 (Add to Cart)
    C -> App: '장바구니 담기' 클릭
    activate App
    App -> App: (useCart) addItem(item)\n(Client-side state update)
    App --> C: (장바구니 UI 업데이트)
    deactivate App
end

' --- 3. (주 흐름 5, 7) 주문서 작성 및 할인 적용 ---
group (3) 주문서 작성 및 할인 계산 (Checkout & Discount)
    C -> App: '주문하기' 클릭 / 배송지 입력
    activate App
    App -> GW: (2) POST /crm/calculate-discount
    activate GW
    GW -> CrmSvc: (라우팅) calculate_final_price()
    activate CrmSvc
    CrmSvc -> UDB: (SQL) (Read-Only) 사용자 등급 조회
    activate UDB
    UDB --> CrmSvc: (등급: GOLD)
    deactivate UDB
    CrmSvc -> CDB: (SQL) (Read-Write) 활성 프로모션 조회
    activate CDB
    CDB --> CrmSvc: (프로모션 목록)
    deactivate CDB
    CrmSvc --> GW: (최종 할인 금액)
    deactivate CrmSvc
    GW --> App: (최종 할인 금액)
    deactivate GW
    App --> C: (최종 결제 금액 표시)
    deactivate App
end

' --- 4. (주 흐름 10, 12) 최종 결제 및 주문 생성 ---
group (4) 결제 및 주문 생성 (Place Order Transaction)
    C -> App: '결제하기' 클릭
    activate App
    App -> GW: (3) POST /orders/create\n(모든 주문 데이터 포함)
    activate GW
    GW -> OrderSvc: (라우팅) create_order_transaction()
    activate OrderSvc

    ' --- 오케스트레이션 시작 ---
    group 주문 생성 트랜잭션 (OrderOrchestratorService)

        ' (A) 재고 확인/차감
        OrderSvc -> GW: (A) POST /inventory/decrement
        activate GW
        GW -> MenuSvc: (라우팅) atomic_decrement_stock()
        activate MenuSvc
        MenuSvc -> PDB: (SQL) (Atomic) UPDATE stock...
        activate PDB

        alt (부 흐름 3a) 재고 부족 (Stock Failure)
            PDB --> MenuSvc: (Error: Out of Stock)
            deactivate PDB
            MenuSvc --> GW: (Error)
            deactivate MenuSvc
            GW --> OrderSvc: (Error: 재고 부족)
            deactivate GW
            OrderSvc --> GW: (Error Response)
            deactivate OrderSvc
            GW --> App: (Error: "재고가 부족합니다")
            deactivate GW
            App --> C: "죄송합니다. [메뉴명]이 품절되었습니다."
            deactivate App
        else (A) 재고 차감 성공 (Stock Success)
            PDB --> MenuSvc: (Success)
            deactivate PDB
            MenuSvc --> GW: (Success)
            deactivate MenuSvc
            GW --> OrderSvc: (Success)
            deactivate GW

            ' (B) 결제 처리
            OrderSvc -> GW: (B) POST /payments/process
            activate GW
            GW -> PaySvc: (라우팅) request_payment()
            activate PaySvc
            PaySvc -> PG: (PG API) create_charge()
            activate PG

            alt (부 흐름 11a) 결제 실패 (Payment Failure)
                PG --> PaySvc: (Error: Payment Denied)
                deactivate PG
                PaySvc --> GW: (Error)
                deactivate PaySvc
                GW --> OrderSvc: (Error: 결제 실패)
                deactivate GW
                OrderSvc -> OrderSvc: (트랜잭션 롤백: 재고 원복 요청)
                OrderSvc --> GW: (Error Response)
                deactivate OrderSvc
                GW --> App: (Error: "결제에 실패했습니다")
                deactivate GW
                App --> C: "결제에 실패했습니다. 다시 시도해 주세요."
                deactivate App
            else (B) 결제 성공 (Payment Success)
                PG --> PaySvc: (Success: Transaction ID)
                deactivate PG
                PaySvc --> GW: (Success)
                deactivate PaySvc
                GW --> OrderSvc: (Success)
                deactivate GW

                ' (C) 주문 저장
                OrderSvc -> ODB: (C) (SQL) INSERT INTO orders...
                activate ODB
                ODB --> OrderSvc: (Success)
                deactivate ODB
                OrderSvc -> OrderSvc: (트랜잭션 커밋)
            end
        end
    end group

    ' --- (사후 조건) 성공 응답 및 알림 ---
    OrderSvc --> GW: (Success: 주문 생성됨)
    deactivate OrderSvc
    GW --> App: (Success: 주문 완료)
    deactivate GW
    App --> C: '주문이 완료되었습니다.' 페이지 표시
    deactivate App

    OrderSvc -> Admin: (Async/WebSocket) '신규 주문' 푸시 알림
    OrderSvc ->> C: (Async) '주문 완료' 이메일/알림
end
@enduml