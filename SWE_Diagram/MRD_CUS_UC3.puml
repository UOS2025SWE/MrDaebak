@startuml
title "MRD-CUS-UC3: 챗봇 주문 (Order via Chatbot) 교류도"

actor "고객 (Customer)" as C
participant "Client App\n(ChatbotUI)" as App
participant "External\n(Google Gemini API)" as Gemini
participant "API Gateway\n(FastAPI)" as GW
participant "Order Service\n(FastAPI)" as OrderSvc
database "OrderDB\n(Order Schema)" as ODB

skinparam ParticipantPadding 20
skinparam BoxPadding 10

' --- 1. (주 흐름 1, 3) 의도 입력 (ASR/Text) ---
group (1) 챗봇 활성화 및 의도 입력
    C -> App: (1) 챗봇 아이콘 클릭 [cite: 99]
    activate App
    App --> C: 챗봇 UI 활성화

    alt (주 흐름 S2) 음성 입력 (Voice Input) [cite: 99]
        C -> App: (3) "안심 스테이크 2개..." (음성)
        App -> Gemini: (ASR) speechToText(audio) [cite: 18]
        activate Gemini
        Gemini --> App: (Text: "안심 스테이크 2개...")
        deactivate Gemini

    else (주 흐름 S1) 텍스트 입력 (Text Input) [cite: 99]
        C -> App: (3) "안심 스테이크 2개..." (텍스트)
    end
end

' --- 2. (주 흐름 8) 의도 분석 및 확정 ---
group (2) 의도 분석 및 주문 확정
    App -> Gemini: (NLP) textToNlp(text) [cite: 18, 20]
    activate Gemini

    alt (부 흐름 5a) 의도 파악 실패
        Gemini --> App: (Error: '메뉴 확인 필요') [cite: 101]
        deactivate Gemini
        App --> C: "죄송합니다. 어떤 스테이크로 하시겠어요?" [cite: 102]
        deactivate App

    else (주 흐름 / 부 흐름 7a) 의도 파악 성공 (커스텀 데코 포함) [cite: 104]
        Gemini --> App: (JSON + 확인 메시지)
        deactivate Gemini
        App --> C: "주문 확인: ... 맞으신가요?" [cite: 104]
        C -> App: (8) "응, 맞아" (확인) [cite: 100]

        ' --- 3. (주 흐름 10) 주문 생성 및 결제 ---
        group (3) 주문 생성 (MRD-CUS-UC2와 동일한 트랜잭션) [cite: 41, 42]
            App -> GW: POST /orders/chatbot (JSON) [cite: 41]
            activate GW
            GW -> OrderSvc: (라우팅) create_chatbot_order() [cite: 41]
            activate OrderSvc

            loop (주문 트랜잭션 오케스트레이션) [cite: 41, 42]
                OrderSvc -> GW: (A) 재고 확인/차감 (to MenuSvc)
                GW --> OrderSvc: (재고 OK)
                OrderSvc -> GW: (B) 할인 계산 (to CrmSvc)
                GW --> OrderSvc: (할인 적용)
                OrderSvc -> GW: (C) (10) 결제 요청 (to PaySvc) [cite: 100]
                GW --> OrderSvc: (결제 성공)
                OrderSvc -> ODB: (D) (SQL) INSERT INTO orders... [cite: 42, 61]
                activate ODB
                ODB --> OrderSvc: (Success)
                deactivate ODB
            end

            OrderSvc --> GW: (주문 생성 성공) [cite: 97, 98]
            deactivate OrderSvc
            GW --> App: (주문 생성 성공)
            deactivate GW
            App --> C: "주문이 성공적으로 완료되었습니다."
            deactivate App
        end
    end
end
@enduml