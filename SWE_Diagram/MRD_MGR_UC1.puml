@startuml
title "MRD-MGR-UC1: 재고 및 회계 관리 (Manage Inventory and Finance) 교류도"

actor "매니저 (Manager)" as M
participant "Admin App\n(Next.js)" as AdminApp
participant "API Gateway\n(FastAPI)" as GW

' -- 백엔드 마이크로서비스 --
participant "Menu & Inv. Service" as MenuSvc
database "ProductDB\n(Product Schema)" as PDB
participant "CRM & Discount Service" as CrmSvc
database "OrderDB\n(Order Schema)" as ODB

skinparam ParticipantPadding 20
skinparam BoxPadding 10

' --- (전제) 매니저 로그인 및 권한 확인 ---
M -> AdminApp: (로그인)
activate AdminApp
AdminApp -> GW: (AdminAuthModule) adminLogin()
activate GW
GW -> AdminApp: (JWT + role: "Manager")
deactivate GW
AdminApp -> AdminApp: (RBACWrapper) 'Manager' 권한 확인
deactivate AdminApp


' --- 1. (주 흐름 S1) 재고 관리 ---
group (S1) 재고 관리 (Manage Inventory)
    M -> AdminApp: (1) '재고 관리' 메뉴 클릭
    activate AdminApp
    ' (InventoryControl 컴포넌트 로드)
    AdminApp -> GW: (InventoryControl) GET /inventory
    activate GW
    GW -> MenuSvc: (라우팅) get_inventory()
    activate MenuSvc
    MenuSvc -> PDB: (SQL) (MenuRepository) get_full_inventory_list()
    activate PDB
    PDB --> MenuSvc: (재고 목록)
    deactivate PDB
    MenuSvc --> GW: (재고 목록 JSON)
    deactivate MenuSvc
    GW --> AdminApp: (재고 목록 JSON)
    deactivate GW
    AdminApp --> M: (재고 현황판 렌더링)

    ... (매니저가 항목 확인) ...

    M -> AdminApp: (3, 5) '안심 500g' -> '입고' (+10) 확인
    AdminApp -> GW: (InventoryControl) PUT /inventory/update
    activate GW
    GW -> MenuSvc: (라우팅) update_stock()
    activate MenuSvc
    MenuSvc -> PDB: (SQL) (MenuRepository) update_inventory_item()
    activate PDB
    PDB --> MenuSvc: (Success)
    deactivate PDB
    MenuSvc --> GW: (Success)
    deactivate MenuSvc
    GW --> AdminApp: (Success)
    deactivate GW
    AdminApp --> M: (사후) '재고가 업데이트되었습니다.'
    deactivate AdminApp
end

' --- 2. (주 흐름 S2) 회계 (매출) 관리 ---
group (S2) 회계 관리 (Manage Finance)
    M -> AdminApp: (7) '매출/회계' 메뉴 클릭
    activate AdminApp
    ' (FinanceDashboard (가상) 컴포넌트 로드)
    AdminApp -> GW: (가상) GET /crm/reports?range=daily
    activate GW
    GW -> CrmSvc: (라우팅) get_sales_report()
    activate CrmSvc
    ' (CRM 서비스가 OrderDB를 Read-Only로 조회)
    CrmSvc -> ODB: (SQL) (OrderRepositoryReader) (Read-Only) 매출 집계
    activate ODB
    ODB --> CrmSvc: (일일 리포트 데이터)
    deactivate ODB
    CrmSvc --> GW: (리포트 JSON)
    deactivate CrmSvc
    GW --> AdminApp: (리포트 JSON)
    deactivate GW
    AdminApp --> M: (일일 매출 리포트 렌더링)

    ...

    M -> AdminApp: (9) '월간' 조회 클릭
    AdminApp -> GW: (가상) GET /crm/reports?range=monthly
    activate GW
    ' (CRM 서비스가 다시 DB 조회...)
    GW --> AdminApp: (월간 리포트 JSON)
    deactivate GW
    AdminApp --> M: (월간 매출 리포트 렌더링)

    ...

    M -> AdminApp: (11) '엑셀로 다운로드' 클릭
    AdminApp -> AdminApp: (Client-side) JSON to Excel 변환
    AdminApp --> M: (Excel 파일 다운로드)
    deactivate AdminApp
end
@enduml