@startuml
title "MRD-MGR-UC3: 프로모션 관리 (Manage Promotions) 교류도"

actor "매니저 (Manager)" as M
participant "Admin App\n(Next.js)" as AdminApp
participant "API Gateway\n(FastAPI)" as GW
participant "CRM & Discount Service" as CrmSvc
database "PostgreSQL\n(CRM Schema)" as DB

skinparam ParticipantPadding 20
skinparam BoxPadding 10

' --- (전제) 매니저 로그인 및 권한 확인 ---
M -> AdminApp: (1) '프로모션 관리' 메뉴 클릭
activate AdminApp
AdminApp -> AdminApp: (RBACWrapper) (useAdminAuth)\n'Manager' 권한 확인 [cite: 148, 149]
AdminApp --> M: (권한 확인) 프로모션 목록 페이지 렌더링
deactivate AdminApp

' --- 1. (주 흐름) 신규 프로모션 등록 ---
group (주 흐름) 신규 프로모션 등록 [cite: 62-63]
    M -> AdminApp: (3) '새 프로모션 등록' 버튼 클릭
    activate AdminApp
    AdminApp --> M: 프로모션 생성 양식 표시
    M -> AdminApp: (5) 정보(이름, 할인율, 기간 등) 입력 후 '저장' [cite: 63]

    AdminApp -> GW: POST /promotions/create [cite: 175]
    activate GW
    GW -> CrmSvc: (라우팅) create_promotion(data) [cite: 175]
    activate CrmSvc
    CrmSvc -> CrmSvc: (PromotionService) create_new_promotion() [cite: 177]
    CrmSvc -> DB: (CrmRepository) INSERT INTO promotions... [cite: 177, 183]
    activate DB
    DB --> CrmSvc: (Success)
    deactivate DB
    CrmSvc --> GW: (Success 201)
    deactivate CrmSvc
    GW --> AdminApp: (Success 201)
    deactivate GW
    AdminApp --> M: "프로모션이 생성되었습니다." (사후 조건) [cite: 62]
    deactivate AdminApp
end

' --- 2. (부 흐름) 프로모션 조기 종료 ---
group (부 흐름) 프로모션 조기 종료 [cite: 63-64]
    M -> AdminApp: (1) '진행 중' 프로모션 '비활성화' 클릭 [cite: 63]
    activate AdminApp
    AdminApp --> M: (2) "정말로... 종료하시겠습니까?" 팝업 [cite: 63]
    M -> AdminApp: (3) '확인' 클릭 [cite: 64]

    AdminApp -> GW: (추정) PUT /promotions/{id} (Body: "status": "TERMINATED") [cite: 146]
    activate GW
    GW -> CrmSvc: (라우팅) update_promotion(id, data) [cite: 146]
    activate CrmSvc
    CrmSvc -> CrmSvc: (PromotionService) (추정) end_promotion(id)
    CrmSvc -> DB: (CrmRepository) (4) UPDATE promotions SET status='TERMINATED'... [cite: 64]
    activate DB
    DB --> CrmSvc: (Success)
    deactivate DB
    CrmSvc --> GW: (Success)
    deactivate CrmSvc
    GW --> AdminApp: (Success)
    deactivate GW
    AdminApp --> M: "프로모션이 종료되었습니다." (사후 조건) [cite: 62]
    deactivate AdminApp
end
@enduml