@startuml
title "Backend Order & Payment - 클래스 다이어그램"

skinparam classAttributeIconSize 0
skinparam defaultFontName "Malgun Gothic"
skinparam shadowing false
skinparam linetype ortho

interface "Next.js Frontend" as IFrontend {
  + POST /api/orders
  + POST /api/checkout/checkout
  + GET  /api/orders/user/{user_id}
  + GET  /api/checkout/payment-info/{order_id}
  + GET  /api/checkout/payments/user/{user_id}
}

interface "PostgreSQL Database" as IDatabase {
  + orders
  + order_items
  + order_side_dishes
  + order_item_customizations
  + cake_customizations
  + order_inventory_reservations
  + mock_payments
}

class "OrderRouter\n(routers/order.py)" as OrderRouter {
  + POST /api/orders
  + GET  /api/orders/{order_id}
  + GET  /api/orders/user/{user_id}
  + POST /api/orders/reorder/{order_id}
  + PATCH /api/orders/{order_id}/status
  + POST /api/orders/{order_id}/cancel
  + GET  /api/orders/staff/all
}

class "CheckoutRouter\n(routers/checkout.py)" as CheckoutRouter {
  + POST /api/checkout/checkout
  + GET  /api/checkout/delivery-info/{user_id}
  + PUT  /api/checkout/delivery-info/{user_id}
  + GET  /api/checkout/payment-info/{order_id}
  + GET  /api/checkout/payments/user/{user_id}
}

class "OrderService\n(services/order_service.py)" as OrderService {
  + create_order(db, order_data): dict
  + get_user_orders(db, user_id): dict
  + consume_order_inventory(db, order_id): dict
  + get_base_ingredients(db, dinner_code, style): dict
  - _create_order_internal(...)
  - _calculate_customization_cost(...)
  - _prepare_side_dishes(...)
  - _check_and_consume_ingredients(...)
  - _store_cake_customization(...)
  - _store_inventory_reservations(...)
  - _generate_order_number(db): str
}

class "PaymentService\n(services/payment_service.py)" as PaymentService {
  + process_mock_payment(order_id, amount, card_number, cardholder_name, expiry_date, cvc, db): dict
  + get_payment_info(order_id, db): dict
  + get_user_payments(user_id, db): list
  + validate_card_number(card_number): bool
  + mask_card_number(card_number): str
}

class "DiscountService\n(services/discount_service.py)" as DiscountService {
  + calculate_order_pricing(user_id, original_price, db): dict
  + increment_user_orders(user_id, db, total_price): bool
}

class "WebSocketManager\n(services/websocket_manager.py)" as WebSocketManager {
  + broadcast_to_staff(message)
  + send_to_user(user_id, message)
}

class "Order (Entity)\norders" as OrderEntity {
  - order_id: UUID <<PK>>
  - order_number: TEXT
  - customer_id: UUID
  - store_id: UUID
  - order_status: TEXT
  - payment_status: TEXT
  - total_price: NUMERIC
  - delivery_address: TEXT
  - delivery_time_estimated: TIMESTAMP
  - inventory_consumed: BOOLEAN
  - created_at: TIMESTAMP
}

class "OrderItem (Entity)\norder_items" as OrderItemEntity {
  - order_item_id: UUID <<PK>>
  - order_id: UUID
  - menu_item_id: UUID
  - serving_style_id: UUID
  - quantity: INT
  - price_per_item: NUMERIC
}

class "OrderSideDish (Entity)\norder_side_dishes" as OrderSideDishEntity {
  - order_side_dish_id: UUID <<PK>>
  - order_id: UUID
  - side_dish_id: UUID
  - quantity: INT
  - price_per_unit: NUMERIC
  - total_price: NUMERIC
}

class "OrderItemCustomization\norder_item_customizations" as OrderItemCustomizationEntity {
  - customization_id: UUID <<PK>>
  - order_item_id: UUID
  - item_name: TEXT
  - change_type: TEXT
  - quantity_change: INT
}

class "CakeCustomization\ncake_customizations" as CakeCustomizationEntity {
  - cake_customization_id: UUID <<PK>>
  - order_item_id: UUID
  - customer_id: UUID
  - image_path: TEXT
  - message: TEXT
  - flavor: TEXT
  - size: TEXT
  - status: VARCHAR
}

class "MockPayment (Entity)\nmock_payments" as MockPaymentEntity {
  - payment_id: UUID <<PK>>
  - order_id: UUID
  - transaction_id: TEXT
  - amount: NUMERIC
  - status: TEXT
  - masked_card_number: TEXT
  - cardholder_name: TEXT
  - error_message: TEXT
  - created_at: TIMESTAMP
}

IFrontend -> OrderRouter : 주문 생성/조회
IFrontend -> CheckoutRouter : 체크아웃/결제

OrderRouter ..> OrderService
OrderRouter ..> DiscountService : "PREPARING 전환 시 로열티 증가"
OrderRouter ..> WebSocketManager : "ORDER_CREATED / STATUS_CHANGED"

CheckoutRouter ..> OrderService
CheckoutRouter ..> PaymentService
CheckoutRouter ..> DiscountService

OrderService ..> IDatabase
PaymentService ..> IDatabase
DiscountService ..> IDatabase

OrderEntity "1" -- "1..*" OrderItemEntity
OrderEntity "1" -- "0..*" OrderSideDishEntity
OrderItemEntity "1" -- "0..*" OrderItemCustomizationEntity
OrderItemEntity "1" -- "0..1" CakeCustomizationEntity
OrderEntity "1" -- "0..1" MockPaymentEntity

note right of OrderService
  **주문 도메인 서비스**
  - 메뉴/스타일/수량/사이드/케이크 기반 주문 생성
  - 기본 가격 + 커스터마이징 + 사이드 디시 가격 계산
  - 단골 할인/이벤트 할인과 연계 (DiscountService, EventService)
  - 재고 예약 및 완료 시점 재고 차감
end note

note right of PaymentService
  **Mock 결제 서비스**
  - 카드 번호 검증 및 마스킹
  - MOCK_PAYMENT_MODE 에 따라 성공/실패 시뮬레이션
  - orders.payment_status 및 mock_payments 기록 관리
end note

@enduml


