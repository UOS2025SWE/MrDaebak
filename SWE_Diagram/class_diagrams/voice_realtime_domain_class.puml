@startuml
title "Voice & Realtime Domain"

skinparam classAttributeIconSize 0
skinparam defaultFontName Arial
skinparam shadowing false
skinparam linetype ortho

interface "Database" as IDatabase
interface "Redis Client" as IRedis

class "VoiceRouter\n(routers/voice.py)" as VoiceRouter {
  + POST /api/voice/analyze
  + POST /api/voice/stt
  + POST /api/customizations/generate-ai-image
}

class "VoiceInputRequest" as VoiceInputRequest <<Pydantic>> {
  transcript: str
  user_id: str | None
  session_id: str | None
}

class "VoiceAnalysisResponse" as VoiceAnalysisResponse <<Pydantic>> {
  intent: str
  confidence: float
  response: str
  analysis: dict
  recommended_menu: dict | None
  alternatives: list[dict]
  additional_questions: list[str]
  order_state: dict | None
  state: str
  state_decision: int
  menu_selection: int
  style_selection: int
  quantity: int | None
  customization_overrides: dict
}

class "STTRequest" as STTRequest <<Pydantic>> {
  audio_bytes: bytes
  filename: str
  mime_type: str
  language: str | None
}

class "ImageGenerationRequest" as ImageGenerationRequest <<Pydantic>> {
  prompt: str
  aspect_ratio: str
}

class "WebSocketRouter\n(routers/websocket.py)" as WebSocketRouter {
  + WS /api/ws
  + GET /api/ws/stats
}

class "AIClient\n(services/ai_client.py)" as AIClient {
  + send_stt_request(audio_bytes, filename, mime_type, language): str
  + send_llm_request(transcript, user_id, session_id, context, db): dict
  + send_image_request(prompt, aspect_ratio): bytes
  - wait_for_response(request_id, timeout): dict
  - get_user_order_history(user_id, db): dict
  - get_active_events(db): list
}

class "ConversationSession\n(services/conversation_session.py)" as ConversationSession {
  - session_id: str
  - user_id: str
  - messages: list
  - context: dict
  - order_state: dict
  - created_at: datetime
  - last_activity: datetime
  ---
  + add_message(role, content): void
  + get_context_summary(): str
  + get_order_state_summary(): str
  + update_context(key, value): void
  + update_order_state(**kwargs): void
  + advance_stage(new_stage): void
  + is_expired(timeout_minutes): bool
  + to_dict(): dict
}

class "WebSocketManager\n(services/websocket_manager.py)" as WebSocketManager {
  - active_connections: dict[user_id, WebSocket]
  - user_types: dict[user_id, str]
  ---
  + connect(user_id, user_type, websocket): void
  + disconnect(user_id): void
  + broadcast_to_staff(message): void
  + broadcast_to_role(role, message): void
  + send_to_user(user_id, message): void
  + send_heartbeat(user_id): void
  + get_connection_count(): int
  + get_connection_stats(): dict
}

IDatabase -[hidden]down- IRedis

VoiceRouter -[hidden]down- VoiceInputRequest
VoiceInputRequest -[hidden]down- VoiceAnalysisResponse
VoiceAnalysisResponse -[hidden]down- STTRequest
STTRequest -[hidden]down- ImageGenerationRequest

AIClient -[hidden]down- ConversationSession

WebSocketRouter -[hidden]down- WebSocketManager

VoiceRouter ..> VoiceInputRequest
VoiceRouter ..> VoiceAnalysisResponse
VoiceRouter ..> STTRequest
VoiceRouter ..> ImageGenerationRequest
VoiceRouter ..> AIClient
VoiceRouter ..> ConversationSession

WebSocketRouter ..> WebSocketManager

AIClient ..> IRedis
AIClient ..> IDatabase
AIClient ..> ConversationSession

WebSocketManager ..> IDatabase

@enduml
