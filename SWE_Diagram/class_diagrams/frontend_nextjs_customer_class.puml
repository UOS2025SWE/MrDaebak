@startuml
title "Next.js 15 Frontend (Customer App) - 클래스 다이어그램"

skinparam classAttributeIconSize 0
skinparam defaultFontName "Malgun Gothic"
skinparam shadowing false
skinparam linetype ortho

interface "FastAPI Backend" as IBackend {
  + POST /api/auth/login
  + POST /api/auth/register
  + GET  /api/menu
  + GET  /api/side-dishes
  + GET  /api/discount/{user_id}
  + POST /api/checkout/checkout
  + GET  /api/checkout/delivery-info/{user_id}
  + GET  /api/checkout/payment-info/{order_id}
  + GET  /api/orders/user/{user_id}
  + POST /api/orders/reorder/{order_id}
  + POST /api/voice/analyze
  + POST /api/voice/tts
  + POST /api/inquiries
  + WS   /api/ws?token=JWT
}

interface "Browser APIs" as IBrowser {
  + localStorage (JWT, user)
}

' ===============================
' 1. Contexts
' ===============================

class "CustomerAuthContext\n(contexts/AuthContext.tsx)" as CustomerAuthContext {
  - user: User | null
  - token: string | null
  - loading: boolean
  ---
  + login(email, password): Promise<void>
  + logout(): void
  + isLoggedIn(): boolean
}

class "CartContext\n(contexts/CartContext.tsx)" as CartContext {
  - items: CartItem[]
  - scheduledDate: string | null
  - scheduledTimeSlot: string | null
  ---
  + addItem(menuCode, style, quantity, customizations, sideDishes, cakeCustomization): void
  + removeItem(index): void
  + clear(): void
}

class "ToastContext\n(contexts/ToastContext.tsx)" as ToastContext {
  - toasts: Toast[]
  ---
  + showToast(message, type): void
  + removeToast(id): void
}

' ===============================
' 2. Pages (App Router)
' ===============================

class "HomePage\n(app/page.tsx)" as HomePage {
  - featuredEvents: Event[]
  - featuredMenus: MenuItem[]
  ---
  + loadHomeData(): Promise<void>
}

class "MenuPage\n(app/menu/page.tsx)" as MenuPage {
  - menus: MenuItem[]
  - sideDishes: SideDish[]
  - selectedMenu: MenuItem | null
  - selectedStyle: string | null
  - customizations: dict
  - sideSelections: SideDishSelection[]
  ---
  + loadMenu(): Promise<void>
  + selectMenu(code): void
  + selectStyle(style): void
  + updateCustomization(ingredient, qty): void
  + toggleSideDish(code, quantity): void
  + addToCart(): void
}

class "CheckoutPage\n(app/checkout/page.tsx)" as CheckoutPage {
  - deliveryInfo: DeliveryInfo
  - paymentInfo: PaymentInfo
  - pricing: PricingSummary
  ---
  + loadDefaultDeliveryInfo(userId): Promise<void>
  + submitCheckout(): Promise<void>
}

class "OrdersPage\n(app/orders/page.tsx)" as OrdersPage {
  - orders: OrderSummary[]
  ---
  + loadOrders(userId): Promise<void>
  + reorder(orderId): Promise<void>
}

class "OrderDetailPage\n(app/orders/[orderId]/page.tsx)" as OrderDetailPage {
  - order: OrderDetail | null
  - wsConnected: boolean
  ---
  + loadOrder(orderId): Promise<void>
  + listenOrderStatus(): void
}

class "VoiceOrderPage\n(app/voice/page.tsx)" as VoiceOrderPage {
  - transcript: string
  - aiResponse: string
  - orderPreview: VoiceOrderPreview | null
  ---
  + startRecording(): void
  + stopRecording(): Promise<void>
  + sendTranscript(): Promise<void>
  + confirmOrder(): Promise<void>
}

class "InquiryPage\n(app/support/page.tsx)" as InquiryPage {
  - form: InquiryForm
  ---
  + submitInquiry(): Promise<void>
}

' ===============================
' 3. Components / Hooks
' ===============================

class "ProtectedCustomerRoute\n(components/ProtectedCustomerRoute.tsx)" as ProtectedCustomerRoute {
  + render(children): JSX.Element
}

class "MenuCard\n(components/menu/MenuCard.tsx)" as MenuCard {
  - menu: MenuItem
  + render(): JSX.Element
}

class "OrderHistoryCard\n(components/orders/OrderHistoryCard.tsx)" as OrderHistoryCard {
  - order: OrderSummary
  + render(): JSX.Element
}

class "useCustomerWebSocket\n(hooks/useCustomerWebSocket.ts)" as UseCustomerWebSocket {
  - socket: WebSocket | null
  - isConnected: boolean
  ---
  + connect(token): void
  + disconnect(): void
  + onStatusChange(handler): void
}

' ===============================
' 4. 관계
' ===============================

CustomerAuthContext ..> IBackend : "login / me"
CustomerAuthContext ..> IBrowser : "JWT 저장"
CartContext ..> ToastContext

HomePage ..> CustomerAuthContext
HomePage ..> ToastContext
HomePage ..> IBackend : "이벤트/추천 메뉴 로드"

MenuPage ..> CustomerAuthContext
MenuPage ..> CartContext
MenuPage ..> ToastContext
MenuPage ..> IBackend : "메뉴/사이드 디시 로드"
MenuPage ..> MenuCard

CheckoutPage ..> CustomerAuthContext
CheckoutPage ..> CartContext
CheckoutPage ..> ToastContext
CheckoutPage ..> IBackend : "기본 배송지 / 체크아웃"

OrdersPage ..> CustomerAuthContext
OrdersPage ..> ToastContext
OrdersPage ..> IBackend : "주문 내역 / 재주문"
OrdersPage ..> OrderHistoryCard

OrderDetailPage ..> CustomerAuthContext
OrderDetailPage ..> ToastContext
OrderDetailPage ..> IBackend : "단일 주문 조회"
OrderDetailPage ..> UseCustomerWebSocket : "주문 상태 실시간 수신"

VoiceOrderPage ..> CustomerAuthContext
VoiceOrderPage ..> ToastContext
VoiceOrderPage ..> IBackend : "음성 분석 / TTS / 주문 생성"

InquiryPage ..> ToastContext
InquiryPage ..> IBackend : "고객 문의 등록"

ProtectedCustomerRoute ..> CustomerAuthContext : "로그인 요구"

note right of CartContext
  **장바구니 / 예약 배송**
  - 디너 코스 + 스타일 + 수량 + 재료 커스터마이징
  - 사이드 디시 및 커스텀 케이크 설정 포함
  - scheduledDate / scheduledTimeSlot 로 예약 배송 지원
end note

note right of VoiceOrderPage
  **AI 음성 주문**
  - 브라우저에서 마이크로 녹음 → STT → transcript 전송
  - GeminiService 가 메뉴/스타일/수량/커스터마이징 제안
  - 고객 확인 후 실제 주문 + 결제 플로우로 연결
end note

note right of UseCustomerWebSocket
  **고객용 WebSocket**
  - 로그인 JWT 로 /api/ws 에 연결
  - ORDER_STATUS_CHANGED 이벤트만 필터링하여
    내 주문 상태를 실시간으로 업데이트
end note

@enduml


