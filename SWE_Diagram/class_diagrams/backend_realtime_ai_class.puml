@startuml
title "Backend Realtime & AI Voice - WebSocket / Gemini / OpenAI Audio"

skinparam classAttributeIconSize 0
skinparam defaultFontName "Malgun Gothic"
skinparam shadowing false
skinparam linetype ortho

interface "Next.js Frontend" as IFrontend {
  + WS  /api/ws?token=JWT
  + POST /api/voice/analyze
  + POST /api/voice/tts
}

interface "Google Gemini API\n(google-genai)" as IGeminiAPI {
  + generate_content(model, contents)
}

interface "OpenAI Audio API" as IOpenAIAudio {
  + audio.transcriptions.create(...)
  + audio.speech.create(...)
}

interface "PostgreSQL Database" as IDatabase {
  + users
  + orders
  + order_items
  + order_item_customizations
  + event_promotions / event_*_discounts
}

class "WebSocketRouter\n(routers/websocket.py)" as WebSocketRouter {
  + WS  /api/ws?token=...
  + GET /api/ws/stats
}

class "WebSocketManager\n(services/websocket_manager.py)" as WebSocketManager {
  - active_connections: Dict[user_id, WebSocket]
  ---
  + connect(user_id, user_type, websocket)
  + disconnect(user_id)
  + broadcast_to_staff(message)
  + send_to_user(user_id, message)
  + send_heartbeat(user_id)
}

class "LoginService\n(services/login_service.py)" as LoginService {
  + verify_token(token)
}

class "VoiceRouter\n(routers/voice.py)" as VoiceRouter {
  + POST /api/voice/analyze\nanalyze_voice_order()
  + POST /api/voice/tts\nsynthesize_response()
}

class "GeminiService\n(services/gemini_service.py)" as GeminiService {
  + analyze_voice_input(transcript, user_id?, session_id?, db?): dict
  + get_user_order_history(user_id, db): dict
  + get_active_events(db): dict
}

class "ConversationSession\n(services/gemini_service.py)" as ConversationSession {
  - session_id: str
  - messages: list
  - context: dict
  - order_state: dict
  ---
  + add_message(role, content): void
  + get_context_summary(): str
  + get_order_state_summary(): str
  + update_context(key, value): void
  + update_order_state(**kwargs): void
  + advance_stage(new_stage): void
}

class "OpenAIAudioService\n(services/openai_audio_service.py)" as OpenAIAudioService {
  + transcribe_audio(audio_bytes, filename, mime_type?, language?): str
  + synthesize_speech(text, voice?, audio_format?): (bytes, str)
}

class "OrderService\n(services/order_service.py)" as OrderService {
  + create_order(db, order_data): dict
}

class "PaymentService\n(services/payment_service.py)" as PaymentService {
  + process_mock_payment(...): dict
}

class "DiscountService\n(services/discount_service.py)" as DiscountService {
  + calculate_order_pricing(user_id, original_price, db): dict
}

IFrontend -> WebSocketRouter : "WS 연결"
IFrontend -> VoiceRouter : "음성 주문 / TTS"

WebSocketRouter ..> WebSocketManager
WebSocketRouter ..> LoginService

WebSocketManager ..> IFrontend : "ORDER_CREATED / STATUS_CHANGED"

VoiceRouter ..> OpenAIAudioService : "STT, TTS"
VoiceRouter ..> GeminiService : "자연어 이해 및 추천"
VoiceRouter ..> OrderService : "AI 기반 주문 생성"
VoiceRouter ..> PaymentService : "결제 호출"
VoiceRouter ..> DiscountService : "단골 할인 반영"

GeminiService ..> IGeminiAPI
GeminiService ..> IDatabase
OpenAIAudioService ..> IOpenAIAudio

GeminiService ..> ConversationSession : "세션 생성/갱신"

note right of WebSocketManager
  **실시간 채널**
  - 직원/관리자에게 주문 생성/상태 변경 이벤트 브로드캐스트
  - 고객에게 개별 주문 상태 변경 알림 전송
  - heartbeat 로 연결 상태 체크
end note

note right of GeminiService
  **음성 주문 파이프라인**
  - STT 결과(텍스트)를 기반으로 intent/메뉴/스타일/수량/커스터마이징 추출
  - 주문 이력 및 활성 이벤트 정보를 프롬프트에 통합
  - ConversationSession 으로 대화/주문 상태 관리
end note

note right of OpenAIAudioService
  **STT/TTS 어댑터**
  - OpenAI SDK v1 기준으로 STT/TTS API 호출 래핑
  - Next.js 프론트엔드가 바로 바이트 스트림과 MIME 타입을 쓸 수 있도록 제공
end note

@enduml


