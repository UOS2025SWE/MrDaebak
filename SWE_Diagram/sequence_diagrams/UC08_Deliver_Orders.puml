@startuml
title "UC-08: Deliver Orders (Delivery Staff)"

actor delivery as "Delivery Staff"
participant "deliveryUI:DeliveryDashboardUI" as deliveryUI
participant "staffR:StaffRouter" as staffR
participant "ordersR:OrdersRouter" as ordersR
participant "loginSvc:LoginService" as loginSvc
participant "orderSvc:OrderService" as orderSvc
participant "wsMan:WebSocketManager" as wsMan

== Load Delivery Orders ==
activate delivery
delivery -> deliveryUI: Open \"Delivery Dashboard\"
deactivate delivery
activate deliveryUI
deliveryUI -> staffR: GET /api/staff/orders?role=DELIVERY\nAuthorization: Bearer JWT
deactivate deliveryUI
activate staffR
staffR -> loginSvc: verify_token(JWT)
activate loginSvc
loginSvc --> staffR: payload (user_type=STAFF,\n position=DELIVERY)
deactivate loginSvc
staffR -> staffR: load orders with status\nPREPARING / DELIVERING
staffR --> deliveryUI: 200 OK
deactivate staffR
activate deliveryUI
deliveryUI --> delivery: Show PREPARING/DELIVERING orders
deactivate deliveryUI

== Start Delivery (PREPARING → DELIVERING) ==
activate delivery
delivery -> deliveryUI: Click \"Start Delivery\" on\norder with status PREPARING
deactivate delivery
activate deliveryUI
deliveryUI -> ordersR: PATCH /api/orders/{order_id}/status\nbody: { new_status: \"DELIVERING\" }
deactivate deliveryUI
activate ordersR
ordersR -> loginSvc: verify_token(JWT)
activate loginSvc
loginSvc --> ordersR: payload
deactivate loginSvc
ordersR -> ordersR: load order_status, customer_id
ordersR -> ordersR: UPDATE order_status='DELIVERING'
ordersR -> wsMan: broadcast_to_staff(ORDER_STATUS_CHANGED)
activate wsMan
ordersR -> wsMan: send_to_user(customer_id,\n ORDER_STATUS_CHANGED)
ordersR --> deliveryUI: { success, status='DELIVERING' }
deactivate ordersR
activate deliveryUI
deliveryUI --> delivery: Update UI
deactivate deliveryUI
deactivate wsMan

== Complete Delivery (DELIVERING → COMPLETED) ==
activate delivery
delivery -> deliveryUI: Click \"Complete Delivery\"
deactivate delivery
activate deliveryUI
deliveryUI -> ordersR: PATCH /api/orders/{order_id}/status\nbody: { new_status: \"COMPLETED\" }
deactivate deliveryUI
activate ordersR
ordersR -> loginSvc: verify_token(JWT)
activate loginSvc
loginSvc --> ordersR: payload
deactivate loginSvc
ordersR -> orderSvc: consume_order_inventory(db, order_id)\n(update inventory + flags)
activate orderSvc
orderSvc --> ordersR: { success }
deactivate orderSvc
ordersR -> ordersR: UPDATE order_status='COMPLETED'
ordersR -> wsMan: broadcast_to_staff(ORDER_STATUS_CHANGED)
activate wsMan
ordersR -> wsMan: send_to_user(customer_id,\n ORDER_STATUS_CHANGED)
ordersR --> deliveryUI: { success, status='COMPLETED' }
deactivate ordersR
activate deliveryUI
deliveryUI --> delivery: Show \"Delivery Completed\"
deactivate deliveryUI
deactivate wsMan

@enduml


