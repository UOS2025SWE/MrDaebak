@startuml
title "Dinner Service - Docker Based Deployment Diagram"

skinparam linestyle ortho
skinparam node {
    BackgroundColor White
    BorderColor Black
}
skinparam component {
    BackgroundColor White
    BorderColor Black
}
skinparam artifact {
    BackgroundColor White
    BorderColor Black
}

' ==========================================
' 1. 컴포넌트 (Component View)
' ==========================================
component "Customer Web App\n(from Component View)" as CustomerApp
component "Admin & Staff Web App\n(from Component View)" as AdminApp
component "Common Components\n(from Component View)" as CommonComp

component "API Routers\n(from Component View)" as ApiRouters
component "Domain Services\n(from Component View)" as DomainServices
component "Integration & Realtime\n(from Component View)" as IntegrationRealtime
component "Persistence\n(from Component View)" as Persistence

component "AIWorker\n(from Component View)" as AIWorker
component "Whisper STT Service\n(from Component View)" as WhisperSTT
component "Qwen LLM Service\n(from Component View)" as QwenLLM
component "Stable Diffusion Image Service\n(from Component View)" as StableDiffusion


' ==========================================
' 2. 아티팩트 (Artifacts)
' ==========================================
artifact "next-app.js\n(Next.js Server)" as NextServer
artifact "build/\n(Static Assets)" as BuildDir

artifact "main.py\n(FastAPI App)" as MainPy
artifact "uvicorn\n(ASGI Server)" as Uvicorn

artifact "postgres\n(PostgreSQL 17)" as PostgresExe
artifact "pgdata/\n(Database Files)" as PgData

artifact "caddy\n(Reverse Proxy)" as CaddyExe
artifact "Caddyfile\n(Routing Config)" as CaddyConf


' ==========================================
' 3. 노드 (Nodes)
' ==========================================
node "Client Browser\n(Desktop / Mobile)" as ClientBrowser

node "Frontend Container\n(dinner_service-frontend)" as FrontendContainer

node "Backend Container\n(dinner_service-backend)" as BackendContainer

node "Database Container\n(dinner_service_db)" as DatabaseContainer

node "Reverse Proxy Container\n(dinner_service_caddy)" as ReverseProxyContainer

node "AI Server Container\n(dinner_service-ai-server)" as AIServerContainer

node "Redis Container\n(dinner_service-redis)" as RedisContainer


' ==========================================
' 4. 물리적 연결 (Physical Connections)
' ==========================================
ClientBrowser -- ReverseProxyContainer : HTTP/HTTPS\n(80, 443)
ReverseProxyContainer -- FrontendContainer : HTTP\n(3000)
ReverseProxyContainer -- BackendContainer : HTTP\n(8000)
BackendContainer -- DatabaseContainer : TCP\n(5432)
BackendContainer -- RedisContainer : TCP\n(6379, RESP)
RedisContainer -- AIServerContainer : TCP\n(6379, RESP)


' ==========================================
' 5. 배포 관계 (Deployment Relationships)
' ==========================================
CustomerApp ..> ClientBrowser : <<deploy>>
AdminApp ..> ClientBrowser : <<deploy>>
CommonComp ..> ClientBrowser : <<deploy>>

ApiRouters ..> BackendContainer : <<deploy>>
DomainServices ..> BackendContainer : <<deploy>>
IntegrationRealtime ..> BackendContainer : <<deploy>>
Persistence ..> BackendContainer : <<deploy>>

AIWorker ..> AIServerContainer : <<deploy>>
WhisperSTT ..> AIServerContainer : <<deploy>>
QwenLLM ..> AIServerContainer : <<deploy>>
StableDiffusion ..> AIServerContainer : <<deploy>>


' ==========================================
' 6. 구현 관계 (Implementation Relationships)
' ==========================================
NextServer ..> FrontendContainer : <<implementation>>
BuildDir ..> FrontendContainer : <<implementation>>

MainPy ..> BackendContainer : <<implementation>>
Uvicorn ..> BackendContainer : <<implementation>>

PostgresExe ..> DatabaseContainer : <<implementation>>
PgData ..> DatabaseContainer : <<implementation>>

CaddyExe ..> ReverseProxyContainer : <<implementation>>
CaddyConf ..> ReverseProxyContainer : <<implementation>>


' ==========================================
' 7. 레이아웃 조정을 위한 히든 링크
' ==========================================
CustomerApp -[hidden]right- AdminApp
AdminApp -[hidden]right- CommonComp

ApiRouters -[hidden]right- DomainServices
DomainServices -[hidden]right- IntegrationRealtime
IntegrationRealtime -[hidden]right- Persistence

AIWorker -[hidden]right- WhisperSTT
WhisperSTT -[hidden]right- QwenLLM
QwenLLM -[hidden]right- StableDiffusion

NextServer -[hidden]right- BuildDir
MainPy -[hidden]right- Uvicorn
PostgresExe -[hidden]right- PgData
CaddyExe -[hidden]right- CaddyConf

CustomerApp -[hidden]down- ClientBrowser
ApiRouters -[hidden]down- BackendContainer
NextServer -[hidden]down- FrontendContainer
PostgresExe -[hidden]down- DatabaseContainer
CaddyExe -[hidden]down- ReverseProxyContainer
AIWorker -[hidden]down- AIServerContainer

ClientBrowser -[hidden]right- ReverseProxyContainer
FrontendContainer -[hidden]right- BackendContainer
BackendContainer -[hidden]right- DatabaseContainer
DatabaseContainer -[hidden]right- RedisContainer
RedisContainer -[hidden]right- AIServerContainer

@enduml
