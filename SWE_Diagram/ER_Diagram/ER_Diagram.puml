@startuml
' Dinner Service Database Schema ER Diagram (2025)

top to bottom direction

skinparam defaultFontName "Arial"
skinparam shadowing false
skinparam linetype ortho
skinparam roundcorner 10
skinparam entity {
    backgroundColor #LightGoldenRodYellow
    borderColor #555
}
skinparam note {
    backgroundColor #EFEFEF
    borderColor #555
}
skinparam nodesep 80
skinparam ranksep 100

' ===============================
' 1. Store / Staff Domain
' ===============================

entity "stores" as stores {
  *store_id : UUID <<PK>>
  --
  name : TEXT <<UNIQUE>>
  address : TEXT
  phone : TEXT
  created_at : TIMESTAMP
}

entity "users" as users {
  *user_id : UUID <<PK>>
  --
  email : TEXT <<UNIQUE>>
  password_hash : TEXT
  name : TEXT
  phone_number : TEXT
  address : TEXT
  user_type : VARCHAR('CUSTOMER','STAFF','MANAGER')
  privacy_consent : BOOLEAN
  created_at : TIMESTAMP
}

entity "staff_details" as staff_details {
  *staff_id : UUID <<PK, FK>>
  --
  store_id : UUID <<FK>>
  position : TEXT
  salary : NUMERIC
  permissions : JSONB
  hired_at : TIMESTAMP
  is_on_duty : BOOLEAN
  last_check_in : TIMESTAMP
  last_check_out : TIMESTAMP
  last_payday : TIMESTAMP
  next_payday : TIMESTAMP
}

entity "staff_termination_logs" as staff_termination_logs {
  *log_id : UUID <<PK>>
  --
  staff_id : UUID
  staff_name : TEXT
  staff_email : TEXT
  position : TEXT
  termination_reason : TEXT
  terminated_at : TIMESTAMP
  terminated_by : UUID <<FK>>
}

note left of users
  **User & Staff Schema**
  - Login/Permission (`user_type`)
  - Staff Details & Termination Log
end note

' ===============================
' 2. Ingredient Intake / Inventory Domain
' ===============================

entity "ingredients" as ingredients {
  *ingredient_id : UUID <<PK>>
  --
  name : TEXT <<UNIQUE>>
  unit : TEXT
  created_at : TIMESTAMP
}

entity "ingredient_pricing" as ingredient_pricing {
  *ingredient_code : TEXT <<PK, FK>>
  --
  unit_price : NUMERIC(12,2)
}

entity "ingredient_intake_batches" as ingredient_intake_batches {
  *batch_id : UUID <<PK>>
  --
  store_id : UUID <<FK>>
  manager_id : UUID <<FK>>
  cook_id : UUID <<FK>>
  status : VARCHAR(32)
  note : TEXT
  created_at : TIMESTAMP
  reviewed_at : TIMESTAMP
  total_expected_cost : NUMERIC(12,2)
  total_actual_cost : NUMERIC(12,2)
}

entity "ingredient_intake_items" as ingredient_intake_items {
  *intake_item_id : UUID <<PK>>
  --
  batch_id : UUID <<FK>>
  ingredient_id : UUID <<FK>>
  expected_quantity : NUMERIC(12,2)
  actual_quantity : NUMERIC(12,2)
  unit_price : NUMERIC(12,2)
  expected_total_cost : NUMERIC(12,2)
  actual_total_cost : NUMERIC(12,2)
  remarks : TEXT
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "store_inventory" as store_inventory {
  *store_id : UUID <<PK, FK>>
  *ingredient_id : UUID <<PK, FK>>
  --
  quantity_on_hand : NUMERIC(12,2)
}

note right of ingredients
  **Inventory & Intake Management**
  - Ingredient Master Data
  - Intake Batch & Unit Price
  - Store-wise Stock Quantity
end note

' ===============================
' 3. Menu / Serving Style / Side Dish Domain
' ===============================

entity "serving_styles" as serving_styles {
  *serving_style_id : UUID <<PK>>
  --
  name : TEXT <<UNIQUE>>
  description : TEXT
  price_modifier : NUMERIC(10,2)
}

entity "menu_items" as menu_items {
  *menu_item_id : UUID <<PK>>
  --
  code : TEXT <<UNIQUE>>
  name : TEXT
  description : TEXT
  base_price : NUMERIC(10,2)
  is_available : BOOLEAN
  created_at : TIMESTAMP
}

entity "menu_serving_style_availability" as menu_serving_style_availability {
  *menu_item_id : UUID <<PK, FK>>
  *serving_style_id : UUID <<PK, FK>>
}

entity "menu_base_ingredients" as menu_base_ingredients {
  *menu_code : TEXT <<PK>>
  *style : TEXT <<PK>>
  *ingredient_code : TEXT <<PK, FK>>
  --
  base_quantity : INT
}

entity "side_dishes" as side_dishes {
  *side_dish_id : UUID <<PK>>
  --
  code : TEXT <<UNIQUE>>
  name : TEXT
  description : TEXT
  base_price : NUMERIC(10,2)
  is_available : BOOLEAN
  created_by : UUID <<FK>>
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "custom_cake_recipes" as custom_cake_recipes {
  *recipe_id : UUID <<PK>>
  --
  flavor : TEXT
  size : TEXT
  ingredient_code : TEXT <<FK>>
  quantity : NUMERIC(12,2)
}

note left of menu_items
  **Menu / Side Dish / Recipe**
  - Dinner Course (`menu_items`)
  - Availability by Serving Style
  - Base Ingredients per Menu/Side
  - Custom Cake Recipes
end note

' ===============================
' 4. Order / Payment Domain
' ===============================

entity "orders" as orders {
  *order_id : UUID <<PK>>
  --
  order_number : TEXT <<UNIQUE>>
  customer_id : UUID <<FK>>
  store_id : UUID <<FK>>
  order_status : TEXT
  payment_status : TEXT
  total_price : NUMERIC(12,2)
  delivery_address : TEXT
  delivery_time_estimated : TIMESTAMP
  inventory_consumed : BOOLEAN
  created_at : TIMESTAMP
}

entity "order_items" as order_items {
  *order_item_id : UUID <<PK>>
  --
  order_id : UUID <<FK>>
  menu_item_id : UUID <<FK>>
  serving_style_id : UUID <<FK>>
  quantity : INT
  price_per_item : NUMERIC(10,2)
}

entity "order_item_customizations" as order_item_customizations {
  *customization_id : UUID <<PK>>
  --
  order_item_id : UUID <<FK>>
  item_name : TEXT
  change_type : TEXT
  quantity_change : INT
}

entity "order_side_dishes" as order_side_dishes {
  *order_side_dish_id : UUID <<PK>>
  --
  order_id : UUID <<FK>>
  side_dish_id : UUID <<FK>>
  quantity : INT
  price_per_unit : NUMERIC(10,2)
  total_price : NUMERIC(12,2)
  notes : TEXT
  created_at : TIMESTAMP
}

entity "cake_customizations" as cake_customizations {
  *cake_customization_id : UUID <<PK>>
  --
  order_item_id : UUID <<FK>>
  customer_id : UUID <<FK>>
  image_path : TEXT
  message : TEXT
  flavor : TEXT
  size : TEXT
  status : VARCHAR(32)
  reviewed_by : UUID <<FK>>
  reviewed_at : TIMESTAMP
  created_at : TIMESTAMP
}

entity "order_inventory_reservations" as order_inventory_reservations {
  *reservation_id : UUID <<PK>>
  --
  order_id : UUID <<FK>>
  ingredient_code : TEXT
  quantity : NUMERIC(12,2)
  consumed : BOOLEAN
  created_at : TIMESTAMP
  consumed_at : TIMESTAMP
}

entity "mock_payments" as mock_payments {
  *payment_id : UUID <<PK>>
  --
  order_id : UUID <<FK>>
  transaction_id : TEXT
  amount : NUMERIC(12,2)
  status : TEXT
  masked_card_number : TEXT
  cardholder_name : TEXT
  error_message : TEXT
  created_at : TIMESTAMP
}

note right of orders
  **Order & Payment**
  - Order Header/Line/Customization
  - Side Dish & Cake Customization
  - Inventory Reservation & Consumption
  - Mock Payment History
end note

' ===============================
' 5. Customer Loyalty / Event / Inquiry Domain
' ===============================

entity "customer_loyalty" as customer_loyalty {
  *customer_id : UUID <<PK, FK>>
  --
  order_count : INT
  total_spent : NUMERIC(12,2)
  vip_level : TEXT
  last_order_at : TIMESTAMP
}

entity "event_promotions" as event_promotions {
  *event_id : UUID <<PK>>
  --
  title : TEXT
  description : TEXT
  image_path : TEXT
  discount_label : TEXT
  start_date : DATE
  end_date : DATE
  tags : JSONB
  is_published : BOOLEAN
  created_by : UUID <<FK>>
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "event_menu_discounts" as event_menu_discounts {
  *event_id : UUID <<PK, FK>>
  *menu_item_id : UUID <<PK, FK>>
  --
  discount_type : VARCHAR(16)
  discount_value : NUMERIC(10,2)
  created_at : TIMESTAMP
}

entity "customer_inquiries" as customer_inquiries {
  *inquiry_id : UUID <<PK>>
  --
  name : TEXT
  email : TEXT
  topic : TEXT
  message : TEXT
  status : VARCHAR(20)
  manager_note : TEXT
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

note right of customer_loyalty
  **CRM & Events**
  - Customer Orders/Spending/VIP Level
  - Promotion Events & Menu Discounts
  - Customer Inquiry Management
end note

' ===============================
' 6. Relationships
' ===============================

' User / Staff
users "1" --|| "0..1" staff_details : "Staff Details (STAFF)"
users "1" --o{ "0..*" staff_termination_logs : "Termination Log (terminated_by)"
users "1" --o{ "0..*" orders : "Customer Orders"
users "1" --|| "0..1" customer_loyalty : "Loyalty Info"

staff_details "0..*" --|| "1" stores : "Belongs to Store"
ingredient_intake_batches "0..*" --|| "1" stores : "Intake Store"
ingredient_intake_batches "0..*" --|| "1" users : "Manager (manager_id)"
ingredient_intake_batches "0..*" --o{ "0..1" users : "Cook (cook_id)"

' Ingredients/Inventory
ingredient_pricing "1" --|| "1" ingredients : "code=name"
ingredient_intake_items "0..*" --|| "1" ingredient_intake_batches : "Batch"
ingredient_intake_items "0..*" --|| "1" ingredients : "Ingredient"
store_inventory "0..*" --|| "1" stores : "Store"
store_inventory "0..*" --|| "1" ingredients : "Ingredient"

' Menu/Style/Side
menu_serving_style_availability "0..*" --|| "1" menu_items : "Menu"
menu_serving_style_availability "0..*" --|| "1" serving_styles : "Style"
menu_base_ingredients "0..*" --|| "1" ingredients : "Base Ingredient (ingredient_code)"
side_dishes "0..*" --o{ "0..*" users : "Created By (created_by)"
custom_cake_recipes "0..*" --|| "1" ingredients : "Cake Ingredient"

' Order/Payment
orders "0..*" --|| "1" stores : "Order Store"
orders "0..*" --o{ "0..1" users : "Customer (customer_id)"
orders "1" --o{ "0..*" order_items : "Order Items"
orders "1" --o{ "0..*" order_side_dishes : "Side Dishes"
orders "1" --o{ "0..*" order_inventory_reservations : "Inventory Reservation"
orders "1" --o{ "0..1" mock_payments : "Payment"

order_items "0..*" --|| "1" menu_items : "Menu"
order_items "0..*" --|| "1" serving_styles : "Style"
order_item_customizations "0..*" --|| "1" order_items : "Ingredient Customization"
order_side_dishes "0..*" --|| "1" side_dishes : "Side Dish"
cake_customizations "0..*" --|| "1" order_items : "Cake"
cake_customizations "0..*" --o{ "0..1" users : "Customer"
order_inventory_reservations "0..*" --|| "1" orders : "Order Reservation"
mock_payments "0..*" --|| "1" orders : "Order Payment"

' Loyalty/Event/Inquiry
customer_loyalty "1" --|| "1" users : "Customer"
event_promotions "0..*" --o{ "0..1" users : "Created By (created_by)"
event_menu_discounts "0..*" --|| "1" event_promotions : "Event"
event_menu_discounts "0..*" --|| "1" menu_items : "Menu"

@enduml