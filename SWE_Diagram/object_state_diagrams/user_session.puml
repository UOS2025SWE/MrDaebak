@startuml
title "AuthContext User Session State Machine"

skinparam shadowing false
skinparam state {
  BackgroundColor #FDF6E3
  BorderColor #555
  RoundCorner 10
}

state "Unauthenticated\n(no token stored)" as Unauthenticated
state "Restoring Session\n(localStorage check)" as Restoring
state "Session Expired\n(token invalid)" as Expired

state "Authenticated" as Authenticated {
  state "Customer" as CustomerState
  state "Staff or Manager" as StaffManagerState
}

[*] --> Unauthenticated

Unauthenticated --> Restoring : useEffect\n(AuthContext.tsx:78)\nlocalStorage.getItem('auth_token')
Restoring --> CustomerState : useEffect\n(AuthContext.tsx:84-85)\nJSON.parse(savedUser)\nuser_type='CUSTOMER'
Restoring --> StaffManagerState : useEffect\n(AuthContext.tsx:84-85)\nJSON.parse(savedUser)\nuser_type∈{'STAFF', 'MANAGER'}
Restoring --> Unauthenticated : useEffect\n(AuthContext.tsx:88-89)\ntoken missing/invalid\nlocalStorage.removeItem()

Unauthenticated --> CustomerState : login()\n(AuthContext.tsx:118)\nPOST /api/auth/login\nuser_type='CUSTOMER'
Unauthenticated --> StaffManagerState : login()\n(AuthContext.tsx:118)\nPOST /api/auth/login\nuser_type∈{'STAFF', 'MANAGER'}

CustomerState --> Expired : useEffect + verifyToken()\n(AuthContext.tsx:232-235)\nsetInterval 5 min\nverifyToken returns false
StaffManagerState --> Expired : useEffect + verifyToken()\n(AuthContext.tsx:232-235)\nsetInterval 5 min\nverifyToken returns false
Expired --> Unauthenticated : logout()\n(AuthContext.tsx:234, 195)\nsetUser(null), setToken(null)\nlocalStorage.removeItem()

CustomerState --> Unauthenticated : logout()\n(AuthContext.tsx:195)\nmanual logout
StaffManagerState --> Unauthenticated : logout()\n(AuthContext.tsx:195)\nmanual logout or session expired

CustomerState --> CustomerState : refreshUserInfo()\n(AuthContext.tsx:203)\nGET /api/auth/me
StaffManagerState --> StaffManagerState : refreshUserInfo()\n(AuthContext.tsx:203)\nGET /api/auth/me

@enduml