@startuml
title "CRM & Discount Service 서브시스템 - 클래스 다이어그램"

skinparam classAttributeIconSize 0
skinparam defaultFontName "Malgun Gothic"
skinparam shadowing false


' --- External Dependencies ---
interface "IApiGateway" {
  + Request
}
' This service is called BY OrderService
interface "IOrderService" {
  + (Calls /crm/calculate-discount)
}



' --- CRM Service Components ---
class "CrmService (FastAPI App)" {
  + handleRequest(request)
}

class "CrmRouter" {
  + calculate_discount(data)
  + create_promotion(data)
  + get_active_promotions()
}

class "DiscountCalculatorService" {
  + calculate_final_price(user_id, cart): float
}

class "PromotionService" {
  + create_new_promotion(data)
  + get_active_list(): Promotion[]
}

class "CrmRepository" {
  ' Read/Write access to CRM Schema
  + get_active_promotions_from_db(): Promotion[]
  + create_promotion_in_db(data)
  + get_user_loyalty_tier(user_id): UserLoyalty
  + analyze_order_history(user_id) ' (Internal cron job)
}

class "UserRepositoryReader" {
  ' Read-Only access to User Schema
  + get_user_by_id(user_id): User
}

class "OrderRepositoryReader" {
  ' Read-Only access to Order Schema
  + get_order_count_by_user(user_id): int
}

' --- Data Entities (in CRM Schema) ---
entity "Promotion" {
  + promotion_id: UUID
  + name: string
  + type: "PERCENT" | "FIXED"
  + value: float
  + start_date: datetime
  + end_date: datetime
  + condition: json ' e.g., {"menu_id": 123}
}

entity "UserLoyalty" {
  + user_id: UUID (PK/FK)
  + tier: "BRONZE" | "SILVER" | "GOLD"
  + points: int
}

' --- Relationships ---
IApiGateway -> "CrmService (FastAPI App)" : "HTTP Request"
IOrderService ..> IApiGateway : "Req /crm/calculate-discount"

"CrmService (FastAPI App)" *-- "CrmRouter" : "1. 라우팅"

' Router delegates logic to services
CrmRouter ..> DiscountCalculatorService : "할인 계산 요청"
CrmRouter ..> PromotionService : "프로모션 관리 요청"

' Services use Repositories
PromotionService ..> CrmRepository : "DB 작업 (Promotion)"

DiscountCalculatorService ..> CrmRepository : "프로모션/등급 조회"
DiscountCalculatorService ..> UserRepositoryReader : "사용자 정보 조회"
DiscountCalculatorService ..> OrderRepositoryReader : "(간접) 주문 이력 조회"

' Repositories interact with DBs
CrmRepository ..> CrmDB : "SQL Query (R/W)"
CrmRepository o-- "Promotion"
CrmRepository o-- "UserLoyalty"
' (CrmRepository might also read from User/Order DBs for analysis)
CrmRepository ..> OrderDB : "SQL Query (Read-Only)"

UserRepositoryReader ..> UserDB : "SQL Query (Read-Only)"
OrderRepositoryReader ..> OrderDB : "SQL Query (Read-Only)"


' --- Notes ---
note "POST /crm/calculate-discount\nPOST /promotions/create\nGET /promotions/active" as Endpoints
CrmRouter .. Endpoints

@enduml