@startuml
title "Payment Service 서브시스템 - 클래스 다이어그램"

skinparam classAttributeIconSize 0
skinparam defaultFontName "Malgun Gothic"
skinparam shadowing false


' --- External Dependencies (Interfaces) ---
' This service is called BY OrderService
interface "IOrderService" {
  + (Calls /payments/process)
  + (Calls /payments/refund)
}

' This service CALLS OrderService (for webhook)
interface "IOrderServiceCallback" {
  + update_order_status(order_id, status)
}

' This service CALLS the external PG
interface "IPaymentGateway" {
  + create_charge(amount, order_id)
  + create_refund(order_id)
}

' --- Payment Service Components ---
class "PaymentService (FastAPI App)" {
  + handleRequest(request)
}

class "PaymentRouter" {
  + process_payment(data)
  + receive_webhook(payload)
  + process_refund(data)
}

class "PaymentGatewayFacade" {
  ' Logic to interact with external PG
  + request_payment(order_id, amount)
  + handle_webhook(payload): ProcessedData
  + request_refund(order_id)
}

' --- Relationships ---
' 1. OrderService calls this service's endpoints
IOrderService -> "PaymentService (FastAPI App)" : "HTTP Request"
"PaymentService (FastAPI App)" *-- "PaymentRouter" : "1. 라우팅"

' 2. The Router delegates all logic to the Facade
PaymentRouter ..> PaymentGatewayFacade : "작업 위임"

' 3. The Facade calls the external PG...
PaymentGatewayFacade ..> IPaymentGateway : "결제/환불 요청 (API Call)"

' 4. ...and also calls back to OrderService via the webhook logic
PaymentGatewayFacade ..> IOrderServiceCallback : "상태 업데이트 요청 (Webhook)"

' 5. The external PG calls this service's webhook endpoint
IPaymentGateway ..> PaymentRouter : "POST /payments/webhook\n(Async Notification)"


' --- Notes ---
note "POST /payments/process\nPOST /payments/webhook\nPOST /payments/refund" as Endpoints
PaymentRouter .. Endpoints

note "이 서비스는 상태 비저장(Stateless)이며\n자체 데이터베이스를 소유하지 않음\n(PCI-DSS 준수)" as Compliance
PaymentService .. Compliance

@enduml