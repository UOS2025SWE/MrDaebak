@startuml
title "MRD-CUS-UC1: 고객 계정 관리 (Customer: Manage Account) 교류도"

actor "고객 (Customer)" as C
participant "Client App\n(Next.js)" as App
participant "API Gateway\n(FastAPI)" as GW
participant "User Service\n(FastAPI)" as UserSvc
database "PostgreSQL\n(User Schema)" as DB

skinparam ParticipantPadding 20
skinparam BoxPadding 10

' --- 주 흐름: 회원가입 (Main Flow: Sign Up) ---
group 회원가입 (Sign Up)
    C -> App: (1) '회원가입' 버튼 클릭 [cite: 82]
    activate App
    App --> C: 회원가입 양식 표시
    deactivate App

    C -> App: (3) 정보 입력 후 '가입하기' 클릭 [cite: 82]
    activate App
    App -> GW: POST /auth/register [cite: 31, 34]
    activate GW
    GW -> UserSvc: (라우팅) register(data) [cite: 31, 36]
    activate UserSvc
    UserSvc -> UserSvc: (AuthService) 비밀번호 해시 [cite: 34, 36]
    UserSvc -> DB: (UserRepository) create_user() [cite: 36, 37]
    activate DB

    alt (부 흐름 3a) 입력 정보 유효하지 않음 [cite: 83]
        DB --> UserSvc: (Error: 이메일 고유성 제약 위반)
        deactivate DB
        UserSvc --> GW: (Error 4xx)
        deactivate UserSvc
        GW --> App: (Error 4xx)
        deactivate GW
        App --> C: 오류 메시지 표시\n(예: "이미 사용 중인 이메일입니다.") [cite: 83]
        deactivate App

    else (주 흐름) 가입 성공
        DB --> UserSvc: (Success)
        deactivate DB
        UserSvc --> GW: (Success 201, 계정 생성됨)
        deactivate UserSvc
        GW --> App: (Success 201)
        deactivate GW
        App --> C: '회원가입 완료' 메시지 표시 (사후 조건) [cite: 81]
        deactivate App
    end
end

' --- 부 흐름: 로그인 (Alternative Flow: Log In) ---
group 로그인 (Log In)
    C -> App: (1) '로그인' 정보 입력 [cite: 84]
    activate App
    App -> GW: POST /auth/login [cite: 31, 34]
    activate GW
    GW -> UserSvc: (라우팅) login(data) [cite: 31, 36]
    activate UserSvc
    UserSvc -> DB: (UserRepository) get_user_by_email() [cite: 36, 37]
    activate DB
    DB --> UserSvc: (User 정보 반환)
    deactivate DB
    UserSvc -> UserSvc: (AuthService) verify_password() [cite: 36]

    alt (부 흐름 2a) 비밀번호 불일치 [cite: 86]
        UserSvc --> GW: (Error 401 Unauthorized)
        deactivate UserSvc
        GW --> App: (Error 401)
        deactivate GW
        App --> C: "이메일 또는 비밀번호가 올바르지 않습니다." [cite: 86]
        deactivate App

    else (로그인 성공)
        UserSvc -> UserSvc: (AuthService) create_access_token() (JWT 발급) [cite: 34, 36]
        UserSvc --> GW: (Success 200 + JWT)
        deactivate UserSvc
        GW --> App: (Success 200 + JWT)
        deactivate GW
        App -> App: (useAuth) JWT 저장 (세션 생성) [cite: 81]
        App --> C: (3) 메인 페이지로 리디렉션 [cite: 85]
        deactivate App
    end
end
@enduml