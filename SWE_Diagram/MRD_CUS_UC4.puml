@startuml
title "MRD-CUS-UC4: 과거 주문 관리 (Manage Past Orders) 교류도"

actor "고객 (Customer)" as C
participant "Client App\n(Next.js)" as App
participant "API Gateway\n(FastAPI)" as GW
participant "Order Service\n(FastAPI)" as OrderSvc
database "OrderDB\n(Order Schema)" as ODB
' (2)번 간편 주문 시나리오를 위해 추가 참여자 선언
participant "Menu & Inv. Service" as MenuSvc
participant "Payment Service" as PaySvc

skinparam ParticipantPadding 20
skinparam BoxPadding 10

' --- 1. (주 흐름 1, 3) 과거 주문 내역 조회 ---
group (1) 시나리오: 과거 주문 내역 조회
    C -> App: (1) '주문 내역 조회' 클릭 [cite: 108]
    activate App
    App -> GW: GET /orders/history
    activate GW
    GW -> OrderSvc: (라우팅) get_history() [cite: 41]
    activate OrderSvc
    ' (JWT의 customer_id 사용)
    OrderSvc -> ODB: (SQL) (OrderRepository) [cite: 42]\nSELECT * FROM orders WHERE customer_id=...
    activate ODB
    ODB --> OrderSvc: (주문 목록)
    deactivate ODB
    OrderSvc --> GW: (주문 목록 JSON)
    deactivate OrderSvc
    GW --> App: (주문 목록 JSON)
    deactivate GW
    App --> C: (3) 주문 내역 목록 표시 [cite: 108]
    deactivate App
end

' --- 2. (주 흐름 5) [S1] 간편 주문 (재주문) ---
group (2) 시나리오: [S1] 간편 주문 (재주문)
    C -> App: (5) '이대로 다시 주문하기' 클릭 [cite: 108]
    activate App
    ' (App은 과거 주문 정보를 기반으로 새 주문 데이터를 구성)
    App -> GW: POST /orders/create
    activate GW
    GW -> OrderSvc: (라우팅) create_order_transaction() [cite: 41]
    activate OrderSvc

    ' (MRD-CUS-UC2의 주문 생성 오케스트레이션과 동일하게 진행) [cite: 41]
    loop (주문 트랜잭션 오케스트레이션) [cite: 41]
        OrderSvc -> GW: (A) POST /inventory/decrement [cite: 45]
        activate GW
        GW -> MenuSvc: (라우팅) atomic_decrement_stock() [cite: 46]
        activate MenuSvc

        alt (부 흐름 5a) 재고 부족 [cite: 110, 111]
            MenuSvc --> GW: (Error: Out of Stock) [cite: 47]
            deactivate MenuSvc
            GW --> OrderSvc: (Error)
            deactivate GW
            OrderSvc --> GW: (트랜잭션 롤백) [cite: 42]\n(Error Response)
            deactivate OrderSvc
            GW --> App: (Error: "품절")
            deactivate GW
            App --> C: "죄송합니다. [메뉴명]이 품절되어..." [cite: 111]
            deactivate App
        else (재고 성공)
            MenuSvc --> GW: (Success) [cite: 47]
            deactivate MenuSvc
            GW --> OrderSvc: (Success)
            deactivate GW

            OrderSvc -> GW: (B) (Payment Service 호출...) [cite: 41, 49]
            activate GW
            GW -> PaySvc: (라우팅) request_payment() [cite: 51]
            activate PaySvc
            PaySvc --> GW: (Success)
            deactivate PaySvc
            GW --> OrderSvc: (Success)
            deactivate GW

            OrderSvc -> ODB: (C) (SQL) INSERT (새 주문) [cite: 42]
            activate ODB
            ODB --> OrderSvc: (Success)
            deactivate ODB
        end
    end

    OrderSvc --> GW: (새 주문 생성 성공)
    deactivate OrderSvc
    GW --> App: (Success)
    deactivate GW
    App --> C: (새 주문 완료/결제 페이지로 이동) [cite: 107]
    deactivate App
end

' --- 3. (주 흐름 7, 9) [S2] 리뷰 작성 ---
group (3) 시나리오: [S2] 리뷰 작성
    C -> App: (7) '리뷰 작성하기' 클릭 (Order 'Delivered') [cite: 109]
    activate App
    App --> C: 리뷰 작성 폼 표시
    C -> App: (9) 리뷰 내용(별점, 텍스트) 제출 [cite: 109]

    ' (리뷰 저장은 Order 또는 CRM Service가 담당. 여기서는 Order로 가정)
    App -> GW: POST /orders/{id}/review
    activate GW
    GW -> OrderSvc: (라우팅) add_review_to_order()
    activate OrderSvc
    OrderSvc -> ODB: (SQL) (OrderRepository)\nUPDATE orders SET review=...
    activate ODB
    ODB --> OrderSvc: (Success)
    deactivate ODB
    OrderSvc --> GW: (Success)
    deactivate OrderSvc
    GW --> App: (Success)
    deactivate GW
    App --> C: "리뷰가 성공적으로 등록되었습니다." [cite: 107]
    deactivate App
end

@enduml