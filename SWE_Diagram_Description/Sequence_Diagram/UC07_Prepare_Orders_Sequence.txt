교류도: Prepare Orders Kitchen (MRD-CUS-UC07)

================================================================================

1. 교류: 조리 대상 주문 목록 조회 (주 흐름 및 부 흐름 2a)

1) 조리사 (Cook) -> CookDashboardUI (cookUI)
- 조리사가 '조리 대시보드(Cook Dashboard)' 페이지를 열어 할당된 주문 확인

2) CookDashboardUI (cookUI) -> StaffRouter (staffR)
- CookDashboardUI가 GET /api/staff/orders?role=COOK 엔드포인트로 주문 목록 조회 요청을 전송
- 요청 헤더: Authorization: Bearer JWT 토큰
- 쿼리 파라미터: role=COOK (조리사 역할 필터)

3) StaffRouter (staffR) -> LoginService (loginSvc)
- StaffRouter가 verify_token(JWT) 메서드를 호출하여 JWT 토큰 검증
- 조리사의 권한 확인 (user_type=STAFF, position=COOK)

4) LoginService (loginSvc) -> StaffRouter (staffR)
- LoginService가 토큰 검증 결과 반환
- 반환 데이터: payload {user_id: string, user_type: STAFF, position: COOK}
- 조리사 권한 확인 완료

5) StaffRouter (staffR) -> StaffRouter (staffR)
- StaffRouter가 load_orders_by_status(role, status) 메서드를 실행하여 주문 조회
- 조회 대상: RECEIVED 또는 PREPARING 상태의 주문
- PostgreSQL에서 orders 테이블 및 관련 테이블(order_items, menus)을 JOIN하여 조회
- 조회되는 데이터: 주문 ID, 주문 번호, 메뉴명, 수량, 스타일, 커스터마이징, 주문 상태, 주문 시간

6) 교류 분기 (Alternative Flow):
- (부 흐름 2a) 할당된 주문 없음 시:
- StaffRouter가 RECEIVED 또는 PREPARING 상태의 주문이 없음을 감지
- StaffRouter가 CookDashboardUI로 빈 배열 {orders: []}을 반환
- CookDashboardUI가 조리사에게 "현재 조리할 주문이 없습니다." 메시지를 표시
- 유즈케이스 종료

- (주 흐름) 할당된 주문 존재 시:
- StaffRouter가 주문 목록을 성공적으로 조회
- 다음 단계로 진행

7) StaffRouter (staffR) -> CookDashboardUI (cookUI)
- 200 OK 상태 코드와 함께 주문 목록을 반환
- 응답 바디: {orders: [...]}
- 각 주문 객체: order_id, order_number, customer_name, menu_items[], order_status, created_at

8) CookDashboardUI (cookUI) -> 조리사 (Cook)
- CookDashboardUI가 RECEIVED/PREPARING 상태의 주문 목록을 화면에 렌더링
- 표시 정보: 주문 번호, 메뉴명, 수량, 스타일, 커스터마이징, 현재 상태, 주문 시간
- RECEIVED 주문에는 '조리 시작' 버튼 표시
- PREPARING 주문에는 '조리 완료' 버튼 표시

================================================================================

2. 교류: 조리 시작 (RECEIVED → PREPARING) (주 흐름 및 부 흐름 4a)

1) 조리사 (Cook) -> CookDashboardUI (cookUI)
- 조리사가 특정 주문의 '조리 시작(Start Cooking)' 버튼을 클릭

2) CookDashboardUI (cookUI) -> OrdersRouter (ordersR)
- CookDashboardUI가 PATCH /api/orders/{order_id}/status 엔드포인트로 상태 변경 요청을 전송
- 요청 바디: {new_status: "PREPARING"}
- 요청 헤더: Authorization: Bearer JWT 토큰

3) OrdersRouter (ordersR) -> LoginService (loginSvc)
- OrdersRouter가 verify_token(JWT) 메서드를 호출하여 JWT 토큰 검증
- 직원 또는 매니저 권한 확인

4) LoginService (loginSvc) -> OrdersRouter (ordersR)
- LoginService가 토큰 검증 결과 반환
- 반환 데이터: payload {user_id, user_type: STAFF or MANAGER}

5) OrdersRouter (ordersR) -> OrdersRouter (ordersR)
- OrdersRouter가 load_order_info(order_id) 메서드를 실행하여 주문 정보 조회
- 조회 대상: order_status, customer_id, total_price
- 현재 상태가 RECEIVED인지 확인 (상태 변경 가능 여부 검증)

6) 교류 분기 (Alternative Flow):
- (부 흐름 4a) 주문 상태 업데이트 실패 시:
- OrdersRouter가 주문 상태를 업데이트할 수 없음을 감지 (예: 주문이 이미 취소됨, 이미 PREPARING 상태)
- OrdersRouter가 CookDashboardUI로 400 Bad Request 또는 409 Conflict 오류를 반환
- 오류 메시지: "주문 상태를 업데이트할 수 없습니다. 주문 정보를 확인해 주세요."
- CookDashboardUI가 조리사에게 오류 메시지를 표시
- 흐름 (1)로 복귀

- (주 흐름) 상태 변경 가능 시:
- 주문 상태가 RECEIVED이며 변경 가능
- 다음 단계로 진행

7) OrdersRouter (ordersR) -> DiscountService (discSvc)
- OrdersRouter가 increment_user_orders(customer_id, db, total_price) 메서드를 호출
- 고객의 주문 횟수 및 누적 금액을 업데이트하여 등급 산정 및 할인 적용에 사용
- DiscountService가 customer_orders_count 및 customer_total_spent를 업데이트

8) DiscountService (discSvc) -> OrdersRouter (ordersR)
- DiscountService가 업데이트 성공 응답 반환
- 응답: {success: true}

9) OrdersRouter (ordersR) -> OrdersRouter (ordersR)
- OrdersRouter가 UPDATE 쿼리를 실행하여 order_status를 'PREPARING'으로 변경
- 업데이트되는 필드: order_status='PREPARING', updated_at=현재 시간
- PostgreSQL의 orders 테이블에서 해당 order_id 레코드 업데이트

10) OrdersRouter (ordersR) -> WebSocketManager (wsMan)
- OrdersRouter가 broadcast_to_staff(ORDER_STATUS_CHANGED) 메서드를 호출
- 모든 연결된 직원(조리사, 배달 담당자, 매니저)에게 주문 상태 변경 알림 전송
- 알림 데이터: {type: "ORDER_STATUS_CHANGED", order_id, old_status: "RECEIVED", new_status: "PREPARING"}

11) OrdersRouter (ordersR) -> WebSocketManager (wsMan)
- OrdersRouter가 send_to_user(customer_id, ORDER_STATUS_CHANGED) 메서드를 호출
- 해당 고객에게 실시간 주문 상태 변경 알림 전송
- 알림 데이터: {type: "ORDER_STATUS_CHANGED", order_id, new_status: "PREPARING"}

12) OrdersRouter (ordersR) -> CookDashboardUI (cookUI)
- 200 OK 상태 코드와 함께 상태 변경 성공 응답을 반환
- 응답 바디: {success: true, status: "PREPARING"}

13) CookDashboardUI (cookUI) -> 조리사 (Cook)
- CookDashboardUI가 해당 주문의 UI를 업데이트하여 상태를 PREPARING으로 표시
- '조리 시작' 버튼이 '조리 완료' 버튼으로 변경됨
- 주문 상태 배지 색상 변경 (예: 회색 → 주황색)

================================================================================

3. 교류: 조리 완료 (PREPARING → DELIVERING) (주 흐름 및 부 흐름 6a)

1) 조리사 (Cook) -> CookDashboardUI (cookUI)
- 조리사가 조리를 완료한 주문의 '조리 완료(Cooking Complete)' 버튼을 클릭

2) CookDashboardUI (cookUI) -> OrdersRouter (ordersR)
- CookDashboardUI가 PATCH /api/orders/{order_id}/status 엔드포인트로 상태 변경 요청을 전송
- 요청 바디: {new_status: "DELIVERING"}
- 요청 헤더: Authorization: Bearer JWT 토큰

3) OrdersRouter (ordersR) -> LoginService (loginSvc)
- OrdersRouter가 verify_token(JWT) 메서드를 호출하여 JWT 토큰 검증
- 직원 또는 매니저 권한 확인

4) LoginService (loginSvc) -> OrdersRouter (ordersR)
- LoginService가 토큰 검증 결과 반환
- 반환 데이터: payload {user_id, user_type}

5) OrdersRouter (ordersR) -> OrdersRouter (ordersR)
- OrdersRouter가 load_order_info(order_id) 메서드를 실행하여 주문 정보 조회
- 조회 대상: order_status, customer_id
- 현재 상태가 PREPARING인지 확인

6) 교류 분기 (Alternative Flow):
- (부 흐름 6a) 주문 상태 업데이트 실패 시:
- OrdersRouter가 주문 상태를 업데이트할 수 없음을 감지 (예: 주문이 이미 DELIVERING 상태)
- OrdersRouter가 CookDashboardUI로 400 Bad Request 또는 409 Conflict 오류를 반환
- 오류 메시지: "주문 상태를 업데이트할 수 없습니다."
- CookDashboardUI가 조리사에게 오류 메시지를 표시
- 흐름 (1)로 복귀

- (주 흐름) 상태 변경 가능 시:
- 주문 상태가 PREPARING이며 변경 가능
- 다음 단계로 진행

7) OrdersRouter (ordersR) -> OrdersRouter (ordersR)
- OrdersRouter가 UPDATE 쿼리를 실행하여 order_status를 'DELIVERING'으로 변경
- 업데이트되는 필드: order_status='DELIVERING', updated_at=현재 시간

8) OrdersRouter (ordersR) -> WebSocketManager (wsMan)
- OrdersRouter가 broadcast_to_staff(ORDER_STATUS_CHANGED) 메서드를 호출
- 모든 연결된 직원에게 주문 상태 변경 알림 전송
- 배달 담당자가 픽업 가능한 주문임을 인지

9) OrdersRouter (ordersR) -> WebSocketManager (wsMan)
- OrdersRouter가 send_to_user(customer_id, ORDER_STATUS_CHANGED) 메서드를 호출
- 해당 고객에게 조리 완료 및 배달 시작 알림 전송
- 알림 데이터: {type: "ORDER_STATUS_CHANGED", order_id, new_status: "DELIVERING"}

10) OrdersRouter (ordersR) -> CookDashboardUI (cookUI)
- 200 OK 상태 코드와 함께 상태 변경 성공 응답을 반환
- 응답 바디: {success: true, status: "DELIVERING"}

11) CookDashboardUI (cookUI) -> 조리사 (Cook)
- CookDashboardUI가 해당 주문의 새 상태를 UI에 반영
- 주문이 DELIVERING 상태로 변경되어 조리사 목록에서 제거되거나 완료 표시
- 주문 상태 배지 색상 변경 (예: 주황색 → 파란색)
- 조리사에게 "조리가 완료되었습니다. 배달 담당자에게 전달되었습니다." 메시지 표시
