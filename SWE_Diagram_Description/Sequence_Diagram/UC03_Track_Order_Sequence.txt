교류도: Track Order Status (MRD-CUS-UC03)

================================================================================

1. 교류: 주문 목록 조회 (주 흐름 및 부 흐름 2a)

1) 고객 (Customer) -> CustomerWebApp (fe)
- 고객이 '내 주문' 페이지를 열어 주문 목록 조회 시작

2) CustomerWebApp (fe) -> OrdersRouter (ordersR)
- CustomerWebApp이 GET /api/orders/user/{user_id} 엔드포인트로 주문 목록 조회 요청을 전송
- 요청 헤더에 Authorization: Bearer JWT 토큰 포함

3) OrdersRouter (ordersR) -> LoginService (loginSvc)
- OrdersRouter가 verify_token(JWT) 메서드를 호출하여 JWT 토큰 검증
- 토큰에서 user_id 추출 및 인증 확인

4) LoginService (loginSvc) -> OrdersRouter (ordersR)
- LoginService가 토큰 검증 결과 반환
- 반환 데이터: 페이로드(user_id, 사용자 유형, 토큰 유효기간)

5) OrdersRouter (ordersR) -> OrderService (orderSvc)
- OrdersRouter가 get_user_orders(db, user_id) 메서드를 호출하여 해당 고객의 모든 주문 조회
- 조회 범위: 주문 헤더 + 주문 항목 + 커스터마이징 정보

6) OrderService (orderSvc) -> PostgreSQL
- OrderService가 orders, order_items, order_item_customizations, order_side_dishes 테이블을 JOIN하여 데이터 조회
- 조회 조건: customer_id = user_id
- 정렬: created_at DESC (최신 주문부터)

7) 교류 분기 (Alternative Flow):
- (부 흐름 2a) 주문 내역 없음 시:
- PostgreSQL이 빈 결과 집합을 반환 (주문 내역이 없음)
- OrderService가 빈 배열을 OrdersRouter로 반환
- OrdersRouter가 CustomerWebApp으로 200 OK와 함께 빈 배열을 반환
- CustomerWebApp이 고객에게 "아직 주문 내역이 없습니다." 메시지를 표시
- 유즈케이스 종료

- (주 흐름) 주문 내역 존재 시:
- PostgreSQL이 주문 목록 데이터를 반환
- 다음 단계로 진행

8) OrderService (orderSvc) -> OrdersRouter (ordersR)
- 주문 목록 조회 성공 응답 반환
- 응답 데이터: {success: true, orders: [...]}
- 각 주문 객체 구조: 주문 ID, 주문 번호, 주문 상태, 결제 상태, 총 가격, 배달 주소, 배달 예정 시간, 주문 항목 배열, 생성 일시

9) OrdersRouter (ordersR) -> CustomerWebApp (fe)
- 200 OK 상태 코드와 함께 주문 목록을 반환

10) CustomerWebApp (fe) -> 고객 (Customer)
- CustomerWebApp이 주문 목록을 화면에 렌더링
- 표시 정보: 주문 번호, 주문 일시, 주문 상태(배지), 총 가격, 메뉴 항목
- 각 주문마다 현재 상태를 색상 및 아이콘으로 시각화 (예: 준비 중-주황색, 배달 중-파란색, 완료-녹색)

================================================================================

2. 교류: 실시간 주문 상태 업데이트 (주 흐름 및 부 흐름 3a, WebSocket 연결 끊김)

1) 고객 (Customer) -> CustomerWebApp (fe)
- 고객이 주문 페이지에 머물며 실시간 업데이트 수신 대기

2) CustomerWebApp (fe) -> WebSocketRouter (wsR)
- CustomerWebApp이 WebSocket 연결 요청을 전송
- 연결 URL: WS /api/ws?token=JWT
- JWT 토큰을 쿼리 파라미터로 전달하여 인증

3) WebSocketRouter (wsR) -> LoginService (loginSvc)
- WebSocketRouter가 verify_token(token) 메서드를 호출하여 JWT 토큰 검증
- WebSocket 연결 시 인증 확인

4) LoginService (loginSvc) -> WebSocketRouter (wsR)
- LoginService가 토큰 검증 결과 반환
- 반환 데이터: user_id, user_type=CUSTOMER

5) WebSocketRouter (wsR) -> WebSocketManager (wsMan)
- WebSocketRouter가 connect(user_id, user_type, websocket) 메서드를 호출하여 연결 등록
- WebSocketManager가 user_id를 키로 WebSocket 연결 객체를 메모리에 저장

6) 교류 분기 (Alternative Flow):
- (부 흐름 3a) WebSocket 연결 실패 시:
- WebSocket 핸드셰이크 실패 또는 네트워크 오류 발생
- WebSocketManager가 연결 실패 응답을 반환
- CustomerWebApp이 고객에게 "실시간 업데이트를 활성화할 수 없습니다." 메시지를 표시
- 수동 새로고침 버튼을 제공하여 고객이 주문 상태를 수동으로 조회 가능
- 흐름 (1)로 복귀 가능 (HTTP를 통한 수동 조회)

- (주 흐름) WebSocket 연결 성공 시:
- WebSocket 핸드셰이크가 정상적으로 완료
- 다음 단계로 진행

7) WebSocketManager (wsMan) -> CustomerWebApp (fe)
- WebSocketManager가 연결 성공 메시지를 WebSocket을 통해 전송
- 메시지 형식: {type: "CONNECTED", timestamp: "2025-01-21T10:30:00Z"}

8) CustomerWebApp (fe)
- CustomerWebApp이 연결 성공 메시지를 수신하고 상태 표시 업데이트
- UI에 "실시간 업데이트 활성화됨" 표시 (예: 녹색 점 또는 아이콘)

... 시간 경과 (주문 상태 변경 발생) ...

9) WebSocketManager (wsMan) -> CustomerWebApp (fe)
- 서버에서 주문 상태가 변경되면 WebSocketManager가 해당 고객에게 실시간 알림 전송
- 메시지 형식: {type: "ORDER_STATUS_CHANGED", data: {order_id: "uuid", old_status: "preparing", new_status: "ready_for_delivery"}}
- 전송 트리거: 직원 또는 매니저가 주문 상태를 업데이트할 때

10) CustomerWebApp (fe) -> CustomerWebApp (fe)
- CustomerWebApp이 수신한 메시지를 파싱하여 해당 주문의 UI 업데이트
- 주문 목록에서 일치하는 order_id의 상태를 새 상태로 변경
- 상태 배지 색상 및 텍스트 업데이트

11) CustomerWebApp (fe) -> 고객 (Customer)
- CustomerWebApp이 토스트 알림 또는 배지를 표시하여 고객에게 상태 변경 알림
- 알림 내용: "주문 #{주문 번호}의 상태가 '{새 상태}'로 변경되었습니다."
- 사운드 또는 진동 알림 추가 가능 (설정에 따라)

12) 교류 분기 (Alternative Flow):
- (WebSocket 연결 끊김 시):
- 네트워크 불안정 또는 서버 재시작으로 인해 WebSocket 연결이 끊어짐
- CustomerWebApp이 onclose 이벤트를 감지하고 자동 재연결 로직 실행
- 재연결 시도: 지수 백오프 전략 사용 (1초, 2초, 4초, ... 최대 30초 간격)
- 재연결 성공 시: 흐름 (7)로 복귀하여 연결 성공 메시지 수신
- 재연결 실패 시: 고객에게 "연결이 끊어졌습니다. 재연결 중입니다..." 메시지 표시하고 계속 재시도
