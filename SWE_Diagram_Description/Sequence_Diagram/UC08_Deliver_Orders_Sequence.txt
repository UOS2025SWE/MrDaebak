교류도: Deliver Orders (MRD-CUS-UC08)

================================================================================

1. 교류: 배달 대상 주문 목록 조회 (주 흐름 및 부 흐름 2a)

1) 배달 담당자 (Delivery Staff) -> DeliveryDashboardUI (deliveryUI)
- 배달 담당자가 '배달 대시보드(Delivery Dashboard)' 페이지를 열어 배달 가능한 주문 확인

2) DeliveryDashboardUI (deliveryUI) -> StaffRouter (staffR)
- DeliveryDashboardUI가 GET /api/staff/orders?role=DELIVERY 엔드포인트로 주문 목록 조회 요청을 전송
- 요청 헤더: Authorization: Bearer JWT 토큰
- 쿼리 파라미터: role=DELIVERY (배달 담당자 역할 필터)

3) StaffRouter (staffR) -> LoginService (loginSvc)
- StaffRouter가 verify_token(JWT) 메서드를 호출하여 JWT 토큰 검증
- 배달 담당자의 권한 확인 (user_type=STAFF, position=DELIVERY)

4) LoginService (loginSvc) -> StaffRouter (staffR)
- LoginService가 토큰 검증 결과 반환
- 반환 데이터: payload {user_id: string, user_type: STAFF, position: DELIVERY}
- 배달 담당자 권한 확인 완료

5) StaffRouter (staffR) -> StaffRouter (staffR)
- StaffRouter가 load_orders_by_status(role, status) 메서드를 실행하여 주문 조회
- 조회 대상: PREPARING 또는 DELIVERING 상태의 주문
- PostgreSQL에서 orders 테이블 및 관련 테이블(order_items, menus, delivery_info)을 JOIN하여 조회
- 조회되는 데이터: 주문 ID, 주문 번호, 고객명, 배달 주소, 전화번호, 메뉴 정보, 주문 상태, 주문 시간

6) 교류 분기 (Alternative Flow):
- (부 흐름 2a) 할당된 주문 없음 시:
- StaffRouter가 PREPARING 또는 DELIVERING 상태의 주문이 없음을 감지
- StaffRouter가 DeliveryDashboardUI로 빈 배열 {orders: []}을 반환
- DeliveryDashboardUI가 배달 담당자에게 "현재 배달할 주문이 없습니다." 메시지를 표시
- 유즈케이스 종료

- (주 흐름) 할당된 주문 존재 시:
- StaffRouter가 주문 목록을 성공적으로 조회
- 다음 단계로 진행

7) StaffRouter (staffR) -> DeliveryDashboardUI (deliveryUI)
- 200 OK 상태 코드와 함께 주문 목록을 반환
- 응답 바디: {orders: [...]}
- 각 주문 객체: order_id, order_number, customer_name, delivery_address, phone, menu_items[], order_status, created_at

8) DeliveryDashboardUI (deliveryUI) -> 배달 담당자 (Delivery Staff)
- DeliveryDashboardUI가 PREPARING/DELIVERING 상태의 주문 목록을 화면에 렌더링
- 표시 정보: 주문 번호, 고객명, 배달 주소, 전화번호, 메뉴 정보, 현재 상태, 주문 시간
- PREPARING 주문에는 '배달 시작' 버튼 표시 (조리 완료된 주문)
- DELIVERING 주문에는 '배달 완료' 버튼 표시 (현재 배달 중인 주문)

================================================================================

2. 교류: 배달 시작 (PREPARING → DELIVERING) (주 흐름 및 부 흐름 4a)

1) 배달 담당자 (Delivery Staff) -> DeliveryDashboardUI (deliveryUI)
- 배달 담당자가 PREPARING 상태의 주문에서 '배달 시작(Start Delivery)' 버튼을 클릭
- 조리가 완료된 주문을 픽업하여 배달 시작

2) DeliveryDashboardUI (deliveryUI) -> OrdersRouter (ordersR)
- DeliveryDashboardUI가 PATCH /api/orders/{order_id}/status 엔드포인트로 상태 변경 요청을 전송
- 요청 바디: {new_status: "DELIVERING"}
- 요청 헤더: Authorization: Bearer JWT 토큰

3) OrdersRouter (ordersR) -> LoginService (loginSvc)
- OrdersRouter가 verify_token(JWT) 메서드를 호출하여 JWT 토큰 검증
- 배달 담당자 권한 확인

4) LoginService (loginSvc) -> OrdersRouter (ordersR)
- LoginService가 토큰 검증 결과 반환
- 반환 데이터: payload {user_id, user_type: STAFF, position: DELIVERY}

5) OrdersRouter (ordersR) -> OrdersRouter (ordersR)
- OrdersRouter가 load_order_info(order_id) 메서드를 실행하여 주문 정보 조회
- 조회 대상: order_status, customer_id
- 현재 상태가 PREPARING인지 확인 (상태 변경 가능 여부 검증)

6) 교류 분기 (Alternative Flow):
- (부 흐름 4a) 주문 상태 업데이트 실패 시:
- OrdersRouter가 주문 상태를 업데이트할 수 없음을 감지 (예: 주문이 이미 DELIVERING 상태, 주문 취소됨)
- OrdersRouter가 DeliveryDashboardUI로 400 Bad Request 또는 409 Conflict 오류를 반환
- 오류 메시지: "주문 상태를 업데이트할 수 없습니다."
- DeliveryDashboardUI가 배달 담당자에게 오류 메시지를 표시
- 흐름 (1)로 복귀

- (주 흐름) 상태 변경 가능 시:
- 주문 상태가 PREPARING이며 변경 가능
- 다음 단계로 진행

7) OrdersRouter (ordersR) -> OrdersRouter (ordersR)
- OrdersRouter가 UPDATE 쿼리를 실행하여 order_status를 'DELIVERING'으로 변경
- 업데이트되는 필드: order_status='DELIVERING', delivery_started_at=현재 시간, updated_at=현재 시간
- PostgreSQL의 orders 테이블에서 해당 order_id 레코드 업데이트

8) OrdersRouter (ordersR) -> WebSocketManager (wsMan)
- OrdersRouter가 broadcast_to_staff(ORDER_STATUS_CHANGED) 메서드를 호출
- 모든 연결된 직원(조리사, 배달 담당자, 매니저)에게 주문 상태 변경 알림 전송
- 알림 데이터: {type: "ORDER_STATUS_CHANGED", order_id, old_status: "PREPARING", new_status: "DELIVERING"}

9) OrdersRouter (ordersR) -> WebSocketManager (wsMan)
- OrdersRouter가 send_to_user(customer_id, ORDER_STATUS_CHANGED) 메서드를 호출
- 해당 고객에게 실시간 배달 시작 알림 전송
- 알림 데이터: {type: "ORDER_STATUS_CHANGED", order_id, new_status: "DELIVERING", message: "배달이 시작되었습니다"}

10) OrdersRouter (ordersR) -> DeliveryDashboardUI (deliveryUI)
- 200 OK 상태 코드와 함께 상태 변경 성공 응답을 반환
- 응답 바디: {success: true, status: "DELIVERING"}

11) DeliveryDashboardUI (deliveryUI) -> 배달 담당자 (Delivery Staff)
- DeliveryDashboardUI가 해당 주문의 UI를 업데이트하여 상태를 DELIVERING으로 표시
- '배달 시작' 버튼이 '배달 완료' 버튼으로 변경됨
- 주문 상태 배지 색상 변경 (예: 주황색 → 파란색)
- 배달 경로 및 고객 정보 강조 표시

================================================================================

3. 교류: 배달 완료 (DELIVERING → COMPLETED) (주 흐름 및 부 흐름 6a, 6b)

1) 배달 담당자 (Delivery Staff) -> DeliveryDashboardUI (deliveryUI)
- 배달 담당자가 고객에게 주문을 전달한 후 '배달 완료(Complete Delivery)' 버튼을 클릭

2) DeliveryDashboardUI (deliveryUI) -> OrdersRouter (ordersR)
- DeliveryDashboardUI가 PATCH /api/orders/{order_id}/status 엔드포인트로 상태 변경 요청을 전송
- 요청 바디: {new_status: "COMPLETED"}
- 요청 헤더: Authorization: Bearer JWT 토큰

3) OrdersRouter (ordersR) -> LoginService (loginSvc)
- OrdersRouter가 verify_token(JWT) 메서드를 호출하여 JWT 토큰 검증
- 배달 담당자 권한 확인

4) LoginService (loginSvc) -> OrdersRouter (ordersR)
- LoginService가 토큰 검증 결과 반환
- 반환 데이터: payload {user_id, user_type: STAFF, position: DELIVERY}

5) OrdersRouter (ordersR) -> OrdersRouter (ordersR)
- OrdersRouter가 load_order_info(order_id) 메서드를 실행하여 주문 정보 조회
- 조회 대상: order_status, customer_id
- 현재 상태가 DELIVERING인지 확인

6) 교류 분기 (Alternative Flow):
- (부 흐름 6a) 주문 상태 업데이트 실패 시:
- OrdersRouter가 주문 상태를 업데이트할 수 없음을 감지 (예: 주문이 이미 COMPLETED 상태)
- OrdersRouter가 DeliveryDashboardUI로 400 Bad Request 또는 409 Conflict 오류를 반환
- 오류 메시지: "배달 완료 처리에 실패했습니다."
- DeliveryDashboardUI가 배달 담당자에게 오류 메시지를 표시
- 흐름 (1)로 복귀

- (주 흐름) 상태 변경 가능 시:
- 주문 상태가 DELIVERING이며 변경 가능
- 다음 단계로 진행

7) OrdersRouter (ordersR) -> OrderService (orderSvc)
- OrdersRouter가 consume_order_inventory(db, order_id) 메서드를 호출하여 재고 차감 처리
- 주문에 사용된 재료의 재고를 실제로 차감하고 order_inventory_reservations의 is_consumed 플래그를 true로 변경

8) OrderService (orderSvc) -> PostgreSQL
- OrderService가 order_inventory_reservations 테이블에서 해당 order_id의 예약 레코드를 조회
- 각 예약된 재료에 대해 store_inventory 테이블의 quantity_on_hand를 차감
- UPDATE store_inventory SET quantity_on_hand = quantity_on_hand - reserved_quantity WHERE ingredient_id = ?
- UPDATE order_inventory_reservations SET is_consumed = true WHERE order_id = ?

9) 교류 분기 (Alternative Flow):
- (부 흐름 6b) 재고 차감 실패 시:
- 재고 업데이트 중 오류 발생 (예: 동시성 문제, 재고가 음수가 됨)
- OrderService가 OrdersRouter로 재고 차감 실패 경고를 반환
- OrdersRouter가 주문은 COMPLETED 상태로 처리하되 경고 로그를 기록
- DeliveryDashboardUI가 배달 담당자에게 "재고 업데이트에 실패했습니다. 관리자에게 문의하세요." 경고 메시지를 표시
- 주문은 완료 처리되지만 수동 재고 조정 필요함을 관리자에게 알림
- 유즈케이스 종료 (주문은 완료 상태)

- (주 흐름) 재고 차감 성공 시:
- 재고가 정상적으로 차감됨
- 다음 단계로 진행

10) OrderService (orderSvc) -> OrdersRouter (ordersR)
- 재고 차감 성공 응답 반환
- 응답 데이터: {success: true}

11) OrdersRouter (ordersR) -> OrdersRouter (ordersR)
- OrdersRouter가 UPDATE 쿼리를 실행하여 order_status를 'COMPLETED'로 변경
- 업데이트되는 필드: order_status='COMPLETED', completed_at=현재 시간, updated_at=현재 시간
- PostgreSQL의 orders 테이블에서 해당 order_id 레코드 업데이트

12) OrdersRouter (ordersR) -> WebSocketManager (wsMan)
- OrdersRouter가 broadcast_to_staff(ORDER_STATUS_CHANGED) 메서드를 호출
- 모든 연결된 직원에게 주문 완료 알림 전송
- 알림 데이터: {type: "ORDER_STATUS_CHANGED", order_id, old_status: "DELIVERING", new_status: "COMPLETED"}

13) OrdersRouter (ordersR) -> WebSocketManager (wsMan)
- OrdersRouter가 send_to_user(customer_id, ORDER_STATUS_CHANGED) 메서드를 호출
- 해당 고객에게 배달 완료 알림 전송
- 알림 데이터: {type: "ORDER_STATUS_CHANGED", order_id, new_status: "COMPLETED", message: "배달이 완료되었습니다"}

14) OrdersRouter (ordersR) -> DeliveryDashboardUI (deliveryUI)
- 200 OK 상태 코드와 함께 배달 완료 성공 응답을 반환
- 응답 바디: {success: true, status: "COMPLETED"}

15) DeliveryDashboardUI (deliveryUI) -> 배달 담당자 (Delivery Staff)
- DeliveryDashboardUI가 배달 완료 확인 메시지를 표시
- 표시 메시지: "배달이 완료되었습니다."
- 해당 주문이 배달 담당자 목록에서 제거되거나 완료 표시
- 주문 상태 배지 색상 변경 (예: 파란색 → 녹색)
- 배달 담당자에게 다음 배달 가능한 주문 안내
