9 "AI & Realtime Domain" 서브시스템 세부 설계

"AI & Realtime Domain" 시스템은 AI 음성 주문과 실시간 WebSocket 알림을 처리하는 백엔드 시스템이다.

Google Gemini 2.0 Flash를 사용한 음성 주문 자연어 이해 기능을 제공한다.
OpenAI Audio API를 통한 STT(Speech-to-Text) 및 TTS(Text-to-Speech) 변환 기능을 제공한다.
대화 세션 관리 및 컨텍스트 유지 기능을 제공하며, 다단계 주문 프로세스를 지원한다.
사용자의 과거 주문 이력 및 현재 진행 중인 이벤트 정보를 기반으로 개인화된 추천을 제공한다.
WebSocket 연결을 통해 실시간 주문 상태 변경 알림을 고객 및 직원에게 전송한다.
직원에게 새로운 주문 배정 알림을 실시간으로 전송한다.
Google Gemini를 사용한 AI 케이크 이미지 생성 및 편집 기능을 제공한다.
Pydantic 모델을 활용하여 요청/응답 데이터 유효성을 검증한다.

"AI & Realtime Domain" 시스템은 아래와 같은 중요한 라우터와 서비스들로 구성되어 있다.

VoiceRouter
음성 주문 관련 모든 엔드포인트를 제공하는 라우터이다.
POST /api/voice/analyze 엔드포인트는 음성 텍스트를 분석하며, VoiceInputRequest 모델을 통해 트랜스크립트, 사용자 ID, 세션 ID를 검증한다.
Gemini 2.0 Flash 모델을 사용하여 사용자 의도를 분석하고, 주문 의도인지, 문의인지, 메뉴 추천 요청인지 등을 파악한다.
VoiceAnalysisResponse 모델을 반환하며, 의도, 신뢰도, 응답 메시지, 추천 메뉴, 대안 메뉴, 추가 질문, 주문 상태 정보를 포함한다.
대화 세션을 관리하여 이전 대화 내용을 기억하고, 다단계 주문 프로세스를 지원한다.
POST /api/voice/tts 엔드포인트는 텍스트를 음성으로 변환하며, TextToSpeechRequest 모델을 통해 텍스트, 음성 타입, 포맷을 검증한다.
OpenAI Audio API를 사용하여 자연스러운 음성을 생성하고, MP3 또는 WAV 형식으로 반환한다.
POST /api/voice/stt 엔드포인트는 음성 파일을 텍스트로 변환하며, OpenAI Whisper 모델을 사용하여 정확한 트랜스크립션을 제공한다.

WebSocketRouter
실시간 WebSocket 연결 관련 엔드포인트를 제공하는 라우터이다.
WS /api/ws 엔드포인트는 WebSocket 연결을 설정하고, 실시간 메시지를 송수신한다.
고객은 주문 상태 변경 알림을 수신하고, 직원은 새로운 주문 배정 알림을 수신한다.
연결 시 사용자 ID 및 사용자 타입(고객, 직원, 매니저)을 전송하여 인증을 수행한다.
heartbeat 메시지를 주기적으로 전송하여 연결 상태를 유지한다.
GET /api/ws/stats 엔드포인트는 현재 활성화된 WebSocket 연결 통계를 조회한다.


9.1 메인 클래스도

VoiceInputRequest (Pydantic 모델)

VoiceInputRequest는 음성 분석 시 사용되는 요청 데이터 모델이다.
transcript 변수에 음성 인식 결과 텍스트를 저장한다.
user_id 변수에 사용자 ID를 저장하며, null인 경우 비회원 음성 주문으로 처리된다.
session_id 변수에 대화 세션 ID를 저장하며, null인 경우 새로운 세션을 생성한다.

VoiceAnalysisResponse (Pydantic 모델)

VoiceAnalysisResponse는 음성 분석 결과를 나타내는 응답 데이터 모델이다.
intent 변수에 사용자 의도를 저장하며, "order"(주문), "inquiry"(문의), "recommendation"(추천 요청) 등의 값을 가진다.
confidence 변수에 의도 분석 신뢰도를 0.0~1.0 범위로 저장한다.
response 변수에 AI 응답 메시지를 저장하며, 사용자에게 표시되거나 TTS로 변환되어 재생된다.
analysis 변수에 상세 분석 결과를 딕셔너리 형태로 저장한다.
recommended_menu 변수에 추천 메뉴 정보를 저장하며, 메뉴 코드, 이름, 설명, 가격, 추천 이유를 포함한다.
alternatives 변수에 대안 메뉴 목록을 저장하며, 추천 메뉴가 마음에 들지 않을 경우 선택할 수 있는 메뉴들을 제공한다.
additional_questions 변수에 AI가 주문을 완성하기 위해 추가로 물어볼 질문 목록을 저장한다.
order_state 변수에 현재 주문 상태 정보를 저장하며, 선택된 메뉴, 스타일, 수량, 커스터마이징 정보를 포함한다.
state 변수에 대화 진행 상태를 저장하며, "greeting", "menu_selection", "style_selection", "customization", "confirmation" 등의 값을 가진다.
state_decision 변수에 상태 전환 결정 코드를 저장한다.
menu_selection 변수에 선택된 메뉴 인덱스를 저장한다.
style_selection 변수에 선택된 스타일 인덱스를 저장한다.
quantity 변수에 주문 수량을 저장한다.
customization_overrides 변수에 재료 커스터마이징 덮어쓰기 정보를 저장한다.

TextToSpeechRequest (Pydantic 모델)

TextToSpeechRequest는 TTS 변환 시 사용되는 요청 데이터 모델이다.
text 변수에 음성으로 변환할 텍스트를 저장한다.
voice 변수에 음성 타입을 저장하며, "alloy", "echo", "fable", "onyx", "nova", "shimmer" 등의 OpenAI 음성 중 하나를 선택할 수 있다.
format 변수에 음성 파일 포맷을 저장하며, "mp3", "wav", "opus" 등의 값을 가진다.

GeminiService (services/gemini_service.py)

GeminiService는 Gemini 2.0 Flash를 사용한 음성 주문 분석 관련 비즈니스 로직을 처리하는 서비스 클래스이다.
analyze_voice_input(transcript, user_id, session_id, db) 함수는 음성 텍스트를 분석하여 사용자 의도를 파악한다.
대화 세션을 조회하거나 새로 생성하고, 이전 대화 내용을 컨텍스트로 활용한다.
사용자의 과거 주문 이력 및 현재 진행 중인 이벤트 정보를 Gemini 프롬프트에 포함하여 개인화된 추천을 제공한다.
Gemini API 응답을 파싱하여 VoiceAnalysisResponse 객체를 생성하고 반환한다.
대화 세션에 새로운 메시지를 추가하고, 주문 상태를 업데이트한다.
get_user_order_history(user_id, db) 함수는 특정 사용자의 과거 주문 이력을 조회하고, 자주 주문한 메뉴, 선호 스타일, 평균 주문 금액 등의 정보를 추출한다.
get_active_events(db) 함수는 현재 진행 중인 이벤트 목록을 조회하고, 이벤트 정보를 Gemini 프롬프트에 포함하여 할인 혜택을 안내한다.
build_conversation_context(...) 함수는 대화 컨텍스트를 구성하여 Gemini 프롬프트를 생성한다.
사용자 정보, 과거 주문 이력, 진행 중인 이벤트, 이전 대화 내용, 현재 주문 상태를 종합하여 컨텍스트를 구성한다.
Gemini LLM API 인터페이스와 Database 인터페이스에 의존하여 AI 모델 및 데이터베이스와 통신한다.

ConversationSession (services/gemini_service.py)

ConversationSession은 음성 주문 대화 세션을 나타내는 클래스이다.
session_id 변수에 세션 고유 ID를 저장한다.
messages 변수에 대화 메시지 목록을 저장하며, 각 메시지는 role(user 또는 assistant)과 content를 포함한다.
context 변수에 세션 컨텍스트 정보를 저장하며, 사용자 선호도, 이전 선택 사항 등을 기록한다.
order_state 변수에 현재 주문 상태를 저장하며, 선택된 메뉴, 스타일, 수량, 커스터마이징 정보를 포함한다.
add_message(role, content) 함수는 새로운 대화 메시지를 추가하며, role은 "user" 또는 "assistant" 값을 가진다.
get_context_summary() 함수는 세션 컨텍스트 요약을 문자열 형태로 반환하며, Gemini 프롬프트에 포함된다.
get_order_state_summary() 함수는 현재 주문 상태 요약을 문자열 형태로 반환한다.
update_context(key, value) 함수는 세션 컨텍스트를 업데이트한다.
update_order_state(**kwargs) 함수는 주문 상태를 업데이트하며, 메뉴, 스타일, 수량, 커스터마이징 정보를 수정할 수 있다.
advance_stage(new_stage) 함수는 대화 진행 단계를 전환하며, "greeting" → "menu_selection" → "style_selection" → "customization" → "confirmation" 순서로 진행한다.

OpenAIAudioService (services/openai_audio_service.py)

OpenAIAudioService는 OpenAI Audio API를 사용한 STT/TTS 관련 비즈니스 로직을 처리하는 서비스 클래스이다.
transcribe_audio(audio_bytes, filename, mime_type, language) 함수는 음성 파일을 텍스트로 변환한다.
OpenAI Whisper 모델을 사용하여 정확한 트랜스크립션을 제공하며, 다국어 지원이 가능하다.
language 파라미터로 음성 언어를 지정할 수 있으며, null인 경우 자동 감지한다.
synthesize_speech(text, voice, audio_format) 함수는 텍스트를 음성으로 변환한다.
OpenAI TTS 모델을 사용하여 자연스러운 음성을 생성하며, 여러 음성 타입 중 선택할 수 있다.
생성된 음성 바이트 데이터와 MIME 타입을 튜플 형태로 반환한다.
OpenAI Audio API 인터페이스에 의존하여 외부 API와 통신한다.

GeminiImageService (services/gemini_image_service.py)

GeminiImageService는 Google Gemini를 사용한 AI 이미지 생성 및 편집 관련 비즈니스 로직을 처리하는 서비스 클래스이다.
generate_image(prompt, aspect_ratio) 함수는 프롬프트를 기반으로 AI 케이크 이미지를 생성한다.
Gemini Imagen 모델을 사용하여 프롬프트에 맞는 케이크 이미지를 생성하고, 생성된 이미지 바이트 데이터와 MIME 타입을 튜플 형태로 반환한다.
aspect_ratio 파라미터로 이미지 비율을 지정할 수 있으며, "1:1", "16:9", "9:16" 등의 값을 가진다.
edit_image(base_image_bytes, base_mime_type, prompt, aspect_ratio) 함수는 기존 이미지를 프롬프트에 따라 편집한다.
Gemini API 인터페이스에 의존하여 외부 AI 모델과 통신한다.

WebSocketManager (services/websocket_manager.py)

WebSocketManager는 실시간 WebSocket 연결 관리 관련 비즈니스 로직을 처리하는 서비스 클래스이다.
active_connections 변수에 현재 활성화된 WebSocket 연결 목록을 딕셔너리 형태로 저장하며, 키는 user_id, 값은 WebSocket 객체이다.
connect(user_id, user_type, websocket) 함수는 새로운 WebSocket 연결을 설정하고, active_connections에 추가한다.
사용자 타입에 따라 고객, 직원, 매니저로 분류하여 관리한다.
disconnect(user_id) 함수는 WebSocket 연결을 종료하고, active_connections에서 제거한다.
broadcast_to_staff(message) 함수는 모든 직원에게 메시지를 브로드캐스트한다.
새로운 주문이 생성되면 모든 직원에게 알림을 전송하며, 주문 배정 시 해당 직원에게만 알림을 전송한다.
send_to_user(user_id, message) 함수는 특정 사용자에게 메시지를 전송한다.
주문 상태가 변경되면 해당 주문의 고객에게 알림을 전송한다.
send_heartbeat(user_id) 함수는 특정 사용자에게 heartbeat 메시지를 전송하여 연결 상태를 확인한다.
Database 인터페이스에 의존하여 사용자 정보 및 주문 정보를 조회한다.

Database (인터페이스)

"AI & Realtime Domain" 시스템의 모든 서비스는 Database 인터페이스를 통해 PostgreSQL 데이터베이스와 통신한다.
이 인터페이스는 실제로는 "Database Layer" 시스템에 구현되어 있으며, SQLAlchemy ORM을 통해 데이터베이스 작업을 수행한다.

Gemini LLM API (인터페이스)

GeminiService와 GeminiImageService는 Gemini LLM API 인터페이스를 통해 Google Gemini 모델과 통신한다.
이 인터페이스는 실제로는 "External Systems" 시스템에 구현되어 있다.

OpenAI Audio API (인터페이스)

OpenAIAudioService는 OpenAI Audio API 인터페이스를 통해 OpenAI Whisper 및 TTS 모델과 통신한다.
이 인터페이스는 실제로는 "External Systems" 시스템에 구현되어 있다.
