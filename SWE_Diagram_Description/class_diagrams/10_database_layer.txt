10 "Database Layer" 서브시스템 세부 설계

"Database Layer" 시스템은 시스템의 모든 영구 데이터를 저장하는 중앙 데이터베이스이다.

PostgreSQL 17을 사용하여 관계형 데이터베이스를 구성한다.
SQLAlchemy ORM을 통해 Python 백엔드 서비스와 데이터베이스 간의 통신을 처리한다.
User, Order, Product 등 각 스키마로 데이터를 구조화하여 저장한다.
트랜잭션 관리를 통해 데이터 일관성을 보장한다.
백엔드 서비스의 SQL Query에 응답하고, CRUD 작업을 수행한다.
데이터베이스 연결 풀링을 통해 성능을 최적화한다.
마이그레이션 관리를 통해 스키마 변경을 안전하게 수행한다.

"Database Layer" 시스템은 아래와 같은 중요한 구성 요소들로 이루어져 있다.

Database Service
데이터베이스 연결 및 세션 관리를 담당하는 서비스 클래스이다.
get_db() 함수는 데이터베이스 세션을 생성하고 반환하며, FastAPI의 Dependency Injection을 통해 각 요청마다 독립적인 세션을 제공한다.
세션은 요청 처리 완료 후 자동으로 닫히며, 트랜잭션이 성공하면 커밋하고 실패하면 롤백한다.
init_database() 함수는 데이터베이스 초기화를 수행하며, 모든 테이블을 생성하고 초기 데이터를 삽입한다.

PostgreSQL Database
모든 시스템 데이터를 저장하는 관계형 데이터베이스이다.
총 20개 이상의 테이블로 구성되어 있으며, 각 테이블은 특정 도메인의 데이터를 저장한다.


10.1 메인 클래스도

Database (services/database.py)

Database는 데이터베이스 연결 및 세션 관리를 담당하는 서비스 클래스이다.
get_db() 함수는 SQLAlchemy 세션을 생성하고 반환한다.
FastAPI의 Dependency Injection 패턴을 통해 각 요청마다 독립적인 세션을 제공하며, yield 키워드를 사용하여 요청 처리 후 세션을 자동으로 닫는다.
트랜잭션 관리를 통해 데이터 일관성을 보장하며, 예외 발생 시 자동으로 롤백한다.
init_database() 함수는 데이터베이스 초기화를 수행한다.
모든 테이블을 생성하며, SQLAlchemy Base.metadata.create_all()을 사용한다.
초기 데이터를 삽입하며, 기본 메뉴, 재료, 사이드 디시 등을 데이터베이스에 추가한다.

PostgreSQL (database)

PostgreSQL은 시스템의 모든 영구 데이터를 저장하는 관계형 데이터베이스이다.
PostgreSQL 17 버전을 사용하며, 최신 기능 및 성능 최적화를 활용한다.

**users 테이블**은 고객 및 직원의 기본 정보를 저장한다.
사용자 ID, 이메일, 비밀번호 해시, 이름, 전화번호, 주소, 역할(고객, 직원, 매니저) 등을 포함한다.

**staff_details 테이블**은 직원의 상세 정보를 저장한다.
포지션(COOK, DELIVERY), 근무 상태(ACTIVE, INACTIVE, TERMINATED), 해고 사유, 입사일, 퇴사일 등을 포함한다.

**orders 테이블**은 주문 기본 정보를 저장한다.
주문 ID, 주문 번호, 사용자 ID, 메뉴 코드, 스타일, 수량, 배송 주소, 주문 상태, 총 금액, 주문 시간 등을 포함한다.

**order_items 테이블**은 주문 항목 상세 정보를 저장한다.
주문 ID, 메뉴 코드, 스타일, 수량, 단가, 소계 금액 등을 포함한다.

**order_item_customizations 테이블**은 주문 항목의 재료 커스터마이징 정보를 저장한다.
주문 항목 ID, 재료 코드, 커스터마이징 수량(추가 또는 제거), 추가 금액 등을 포함한다.

**menu_items 테이블**은 메뉴 기본 정보를 저장한다.
메뉴 코드, 메뉴 이름, 설명, 카테고리, 이미지 경로 등을 포함한다.

**serving_styles 테이블**은 메뉴 스타일별 가격 정보를 저장한다.
메뉴 코드, 스타일(simple, grand, deluxe), 가격, 가용성 등을 포함한다.

**ingredients 테이블**은 재료 기본 정보를 저장한다.
재료 코드, 재료 이름, 단위, 단가, 현재 재고량 등을 포함한다.

**ingredient_stock_history 테이블**은 재고 변동 이력을 저장한다.
재료 코드, 변동 유형(입고, 사용, 조정), 변동 수량, 변동 후 재고량, 변동 시간, 변동 사유 등을 포함한다.

**ingredient_intake_records 테이블**은 재료 입고 예정 정보를 저장한다.
입고 ID, 입고 예정일, 입고 메모, 등록자, 확인자, 확인 상태 등을 포함한다.

**ingredient_intake_items 테이블**은 입고 예정 재료 항목을 저장한다.
입고 ID, 재료 코드, 예정 수량, 실제 수량, 단가, 특이사항 등을 포함한다.

**side_dishes 테이블**은 사이드 디시 기본 정보를 저장한다.
사이드 디시 코드, 이름, 설명, 가격, 가용성, 이미지 경로 등을 포함한다.

**side_dish_ingredients 테이블**은 사이드 디시에 필요한 재료 구성을 저장한다.
사이드 디시 코드, 재료 코드, 필요 수량 등을 포함한다.

**custom_cake_recipes 테이블**은 커스텀 케이크 레시피 정보를 저장한다.
레시피 ID, 레시피 이름, 기본 재료 구성, 가격 등을 포함한다.

**cake_customizations 테이블**은 주문별 케이크 커스터마이징 정보를 저장한다.
주문 ID, 케이크 이미지 경로, 케이크 문구, 크기, 추가 요청사항 등을 포함한다.

**event_promotions 테이블**은 프로모션 이벤트 정보를 저장한다.
이벤트 ID, 이벤트명, 설명, 시작일, 종료일, 우선순위, 활성 여부, 이미지 경로 등을 포함한다.

**event_menu_discounts 테이블**은 이벤트별 메뉴 할인 정보를 저장한다.
이벤트 ID, 할인 대상 타입(MENU, SIDE_DISH), 할인 대상 ID, 할인 유형(PERCENT, FIXED), 할인 값 등을 포함한다.

**loyalty_tier_discounts 테이블**은 충성도 등급별 할인 정보를 저장한다.
등급 ID, 등급명, 최소 주문 횟수, 할인율 등을 포함한다.

**mock_payments 테이블**은 결제 정보를 저장한다.
결제 ID, 주문 ID, 카드 번호(마스킹), 결제 금액, 거래 ID, 결제 상태, 결제 시간 등을 포함한다.

**inquiries 테이블**은 고객 문의 정보를 저장한다.
문의 ID, 사용자 ID, 제목, 내용, 카테고리, 상태(PENDING, IN_PROGRESS, RESOLVED, CLOSED), 등록일, 답변일 등을 포함한다.

모든 테이블은 적절한 인덱스를 통해 쿼리 성능을 최적화하며, 외래 키 제약조건을 통해 데이터 무결성을 보장한다.
트랜잭션 관리를 통해 동시성 제어를 수행하며, ACID 속성을 보장한다.
