7 "User & Auth Domain" 서브시스템 세부 설계

"User & Auth Domain" 시스템은 JWT 기반 인증과 고객 지원 문의를 관리하는 백엔드 시스템이다.

고객 및 직원의 회원가입, 로그인, 프로필 관리를 담당한다.
JWT 토큰 기반 인증을 제공하며, 액세스 토큰 생성 및 검증 기능을 수행한다.
고객 회원가입 시 일반 사용자 계정을 생성하고, 직원 회원가입 시 포지션 미정 상태로 계정을 생성한다.
비밀번호 변경, 토큰 검증, 관리자 권한 확인 기능을 제공한다.
고객 문의 등록 및 상태 관리 기능을 제공하며, 문의 유형별로 분류하여 관리한다.
매니저는 모든 문의를 조회하고 상태를 업데이트할 수 있으며, 고객은 자신의 문의만 조회할 수 있다.
Pydantic 모델을 활용하여 요청/응답 데이터 유효성을 검증한다.

"User & Auth Domain" 시스템은 아래와 같은 중요한 라우터와 서비스들로 구성되어 있다.

AuthRouter
인증 및 사용자 관리 관련 모든 엔드포인트를 제공하는 라우터이다.
POST /api/auth/login 엔드포인트는 로그인을 처리하며, LoginRequest 모델을 통해 이메일과 비밀번호를 검증한다.
인증 성공 시 LoginResponse 모델을 반환하며, JWT 액세스 토큰, 토큰 타입, 만료 시간, 사용자 정보를 포함한다.
POST /api/auth/register 엔드포인트는 고객 회원가입을 처리하며, RegisterRequest 모델을 통해 회원가입 정보를 검증한다.
POST /api/auth/register-staff 엔드포인트는 직원 회원가입을 처리하며, StaffRegisterRequest 모델을 통해 직원 정보를 검증한다.
직원 회원가입 시 포지션 미정(position=null) 상태로 계정이 생성되며, 매니저가 포지션을 배정할 때까지 대기한다.
POST /api/auth/verify-token 엔드포인트는 JWT 토큰의 유효성을 검증하고, 토큰에 포함된 사용자 정보를 반환한다.
GET /api/auth/me 엔드포인트는 현재 로그인한 사용자의 정보를 조회한다.
POST /api/auth/change-password 엔드포인트는 비밀번호 변경을 처리하며, ChangePasswordRequest 모델을 통해 현재 비밀번호와 새 비밀번호를 검증한다.
POST /api/auth/admin/verify 엔드포인트는 현재 사용자가 관리자 권한을 가지고 있는지 확인한다.

InquiriesRouter
고객 문의 관련 모든 엔드포인트를 제공하는 라우터이다.
POST /api/inquiries 엔드포인트는 신규 문의를 등록하며, InquiryCreateRequest 모델을 통해 문의 정보를 검증한다.
GET /api/inquiries 엔드포인트는 문의 목록을 조회하며, status 및 user_id 쿼리 파라미터로 필터링할 수 있다.
매니저는 모든 문의를 조회할 수 있으며, 고객은 자신의 문의만 조회할 수 있다.
GET /api/inquiries/{inquiry_id} 엔드포인트는 특정 문의의 상세 정보를 조회한다.
PATCH /api/inquiries/{inquiry_id}/status 엔드포인트는 문의 상태를 업데이트하며, PENDING, IN_PROGRESS, RESOLVED, CLOSED 등의 상태로 변경할 수 있다.


7.1 메인 클래스도

LoginRequest (Pydantic 모델)

LoginRequest는 로그인 시 사용되는 요청 데이터 모델이다.
email 변수에 사용자 이메일을 EmailStr 타입으로 저장하며, 이메일 형식 유효성을 자동으로 검증한다.
password 변수에 비밀번호를 저장한다.

RegisterRequest (Pydantic 모델)

RegisterRequest는 고객 회원가입 시 사용되는 요청 데이터 모델이다.
email 변수에 사용자 이메일을 EmailStr 타입으로 저장한다.
password 변수에 비밀번호를 저장한다.
name 변수에 사용자 이름을 저장한다.
phone 변수에 전화번호를 저장한다.
address 변수에 주소를 저장한다.

StaffRegisterRequest (Pydantic 모델)

StaffRegisterRequest는 직원 회원가입 시 사용되는 요청 데이터 모델이다.
email 변수에 직원 이메일을 EmailStr 타입으로 저장한다.
password 변수에 비밀번호를 저장한다.
name 변수에 직원 이름을 저장한다.
phone_number 변수에 전화번호를 저장한다.
address 변수에 주소를 저장한다.
store_id 변수에 매장 ID를 저장하며, null인 경우 기본 매장으로 배정된다.

ChangePasswordRequest (Pydantic 모델)

ChangePasswordRequest는 비밀번호 변경 시 사용되는 요청 데이터 모델이다.
current_password 변수에 현재 비밀번호를 저장한다.
new_password 변수에 새 비밀번호를 저장한다.

LoginResponse (Pydantic 모델)

LoginResponse는 로그인 완료 시 반환되는 응답 데이터 모델이다.
success 변수에 로그인 성공 여부를 저장한다.
access_token 변수에 JWT 액세스 토큰을 저장하며, 로그인 실패 시 null 값을 가진다.
token_type 변수에 토큰 타입을 저장하며, 일반적으로 "Bearer" 값을 가진다.
expires_in 변수에 토큰 만료 시간을 초 단위로 저장한다.
user 변수에 사용자 정보 딕셔너리를 저장하며, 사용자 ID, 이름, 이메일, 역할 등을 포함한다.
show_admin_button 변수에 관리자 버튼 표시 여부를 저장하며, 관리자 권한이 있는 경우 True 값을 가진다.
message 변수에 로그인 결과 메시지를 저장한다.
error 변수에 로그인 실패 시 에러 메시지를 저장한다.

InquiryCreateRequest (Pydantic 모델)

InquiryCreateRequest는 문의 등록 시 사용되는 요청 데이터 모델이다.
title 변수에 문의 제목을 저장한다.
content 변수에 문의 내용을 저장한다.
category 변수에 문의 유형을 저장하며, "주문 문의", "배송 문의", "메뉴 문의", "기타" 등의 값을 가진다.
user_id 변수에 문의한 사용자의 ID를 저장하며, 비회원 문의의 경우 null 값을 가진다.

LoginService (services/login_service.py)

LoginService는 인증 및 사용자 관리 관련 비즈니스 로직을 처리하는 서비스 클래스이다.
authenticate_user(db, email, password) 함수는 이메일과 비밀번호를 검증하여 사용자 인증을 수행한다.
비밀번호는 해시된 값과 비교하며, bcrypt 알고리즘을 사용하여 안전하게 검증한다.
인증 성공 시 사용자 정보를 딕셔너리 형태로 반환하고, 실패 시 에러를 발생시킨다.
create_login_response(user_data) 함수는 인증된 사용자 정보를 기반으로 LoginResponse 객체를 생성한다.
JWT 액세스 토큰을 생성하고, 토큰 만료 시간, 사용자 정보, 관리자 버튼 표시 여부를 설정한다.
register_customer(db, ...) 함수는 고객 회원가입을 처리하며, 이메일 중복 확인, 비밀번호 해싱, 사용자 정보 저장을 수행한다.
register_staff_user(db, ...) 함수는 직원 회원가입을 처리하며, 포지션 미정 상태(position=null)로 계정을 생성한다.
create_access_token(data) 함수는 JWT 액세스 토큰을 생성하며, 사용자 ID, 이메일, 역할 정보를 토큰에 포함한다.
verify_token(token) 함수는 JWT 토큰의 유효성을 검증하고, 토큰에 포함된 사용자 정보를 추출하여 반환한다.
토큰이 만료되었거나 유효하지 않은 경우 null 값을 반환한다.
verify_admin_access(db, user_id) 함수는 특정 사용자가 관리자 권한을 가지고 있는지 확인한다.
get_current_user(credentials, db) 함수는 요청 헤더의 JWT 토큰을 검증하고, 현재 로그인한 사용자 정보를 반환한다.
Database 인터페이스에 의존하여 PostgreSQL 데이터베이스와 통신한다.

InquiryService (services/inquiry_service.py)

InquiryService는 고객 문의 관련 비즈니스 로직을 처리하는 서비스 클래스이다.
create_inquiry(db, ...) 함수는 신규 문의를 등록하고, 문의 ID를 반환한다.
문의 상태는 기본적으로 PENDING으로 설정된다.
get_inquiries(db, status, user_id) 함수는 문의 목록을 조회하며, status 및 user_id 파라미터로 필터링할 수 있다.
매니저는 user_id 없이 호출하여 모든 문의를 조회할 수 있으며, 고객은 자신의 user_id로 호출하여 자신의 문의만 조회할 수 있다.
get_inquiry(db, inquiry_id) 함수는 특정 문의의 상세 정보를 조회하고 반환한다.
update_inquiry_status(db, inquiry_id, status) 함수는 문의 상태를 업데이트하며, PENDING, IN_PROGRESS, RESOLVED, CLOSED 등의 상태로 변경할 수 있다.
Database 인터페이스에 의존하여 PostgreSQL 데이터베이스와 통신한다.

Database (인터페이스)

"User & Auth Domain" 시스템의 모든 서비스는 Database 인터페이스를 통해 PostgreSQL 데이터베이스와 통신한다.
이 인터페이스는 실제로는 "Database Layer" 시스템에 구현되어 있으며, SQLAlchemy ORM을 통해 데이터베이스 작업을 수행한다.
