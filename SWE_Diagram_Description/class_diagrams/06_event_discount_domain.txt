6 "Event & Discount Domain" 서브시스템 세부 설계

"Event & Discount Domain" 시스템은 프로모션 이벤트와 고객 충성도 할인을 관리하는 백엔드 시스템이다.

프로모션 이벤트 생성, 조회, 수정, 삭제 기능을 제공하며, 이벤트 이미지 업로드를 지원한다.
이벤트별로 메뉴 또는 사이드 디시에 대한 할인을 설정할 수 있으며, 할인 유형은 퍼센트 또는 고정 금액이다.
고객의 주문 이력을 기반으로 충성도 등급 할인을 자동 적용한다.
충성도 할인 규칙: 5회 이상 주문 시 5% 할인, 10회 이상 주문 시 10% 할인, 20회 이상 주문 시 15% 할인.
할인은 충성도 할인과 이벤트 할인이 누적 적용되며, 충성도 할인이 먼저 계산된 후 이벤트 할인이 적용된다.
주문 완료 시 사용자의 주문 횟수를 증가시켜 충성도 할인 등급을 업데이트한다.
Pydantic 모델을 활용하여 요청/응답 데이터 유효성을 검증한다.

"Event & Discount Domain" 시스템은 아래와 같은 중요한 라우터와 서비스들로 구성되어 있다.

EventsRouter
프로모션 이벤트 관련 모든 엔드포인트를 제공하는 라우터이다.
GET /api/events/ 엔드포인트는 전체 이벤트 목록을 조회하며, is_active 쿼리 파라미터로 활성 이벤트만 필터링할 수 있다.
POST /api/events/ 엔드포인트는 신규 이벤트를 생성하며, EventPayload 모델을 통해 이벤트 정보를 검증한다.
GET /api/events/{event_id} 엔드포인트는 특정 이벤트의 상세 정보를 조회한다.
PUT /api/events/{event_id} 엔드포인트는 특정 이벤트의 정보를 수정하며, EventPayload 모델을 통해 수정 데이터를 검증한다.
DELETE /api/events/{event_id} 엔드포인트는 특정 이벤트를 삭제한다.
POST /api/events/{event_id}/upload-image 엔드포인트는 이벤트 이미지를 업로드하고 저장한다.
GET /api/events/image/{filename} 엔드포인트는 저장된 이벤트 이미지를 조회한다.

DiscountRouter
할인 정보 조회 엔드포인트를 제공하는 라우터이다.
GET /api/discount/{user_id} 엔드포인트는 특정 사용자의 충성도 할인 정보를 조회하며, 현재 주문 횟수, 할인율, 다음 등급까지 필요한 주문 횟수 등을 반환한다.


6.1 메인 클래스도

EventMenuDiscountItem (Pydantic 모델)

EventMenuDiscountItem은 이벤트 할인 대상 항목을 나타내는 모델이다.
target_type 변수에 할인 대상 타입을 저장하며, "MENU" 또는 "SIDE_DISH" 값을 가진다.
target_id 변수에 할인 대상의 ID를 저장하며, null인 경우 모든 메뉴 또는 모든 사이드 디시에 할인이 적용된다.
discount_type 변수에 할인 유형을 저장하며, "PERCENT"(퍼센트 할인) 또는 "FIXED"(고정 금액 할인) 값을 가진다.
discount_value 변수에 할인 값을 저장하며, discount_type이 "PERCENT"인 경우 퍼센트 값(예: 10.0 = 10% 할인), "FIXED"인 경우 고정 금액 값을 나타낸다.

EventPayload (Pydantic 모델)

EventPayload는 이벤트 생성 및 수정 시 사용되는 요청 데이터 모델이다.
title 변수에 이벤트 제목을 저장한다.
description 변수에 이벤트 설명을 저장한다.
start_date 변수에 이벤트 시작일시를 datetime 타입으로 저장한다.
end_date 변수에 이벤트 종료일시를 datetime 타입으로 저장한다.
priority 변수에 이벤트 우선순위를 저장하며, 여러 이벤트가 동시에 활성화된 경우 우선순위가 높은 이벤트가 먼저 적용된다.
is_active 변수에 이벤트 활성 여부를 저장한다.
menu_discounts 변수에 EventMenuDiscountItem 객체 리스트를 저장하며, 이벤트에 포함된 할인 대상 항목 목록을 나타낸다.

EventService (services/event_service.py)

EventService는 이벤트 관련 비즈니스 로직을 처리하는 서비스 클래스이다.
list_events(db, is_active_only) 함수는 전체 이벤트 목록을 조회하며, is_active_only 파라미터가 True인 경우 활성 이벤트만 반환한다.
get_event(db, event_id) 함수는 특정 이벤트의 상세 정보를 조회하고, 이벤트에 포함된 할인 대상 항목 정보를 함께 반환한다.
create_event(db, payload) 함수는 신규 이벤트를 생성하고, payload에 포함된 할인 대상 항목을 함께 저장한다.
update_event(db, event_id, payload) 함수는 특정 이벤트의 정보를 수정하며, 기존 할인 대상 항목을 삭제하고 새로운 항목으로 대체한다.
delete_event(db, event_id) 함수는 특정 이벤트를 삭제하고, 관련된 할인 대상 항목도 함께 삭제한다.
upload_event_image(event_id, file) 함수는 이벤트 이미지를 서버에 저장하고, 저장된 파일 경로를 반환한다.
Database 인터페이스에 의존하여 PostgreSQL 데이터베이스와 통신한다.

DiscountService (services/discount_service.py)

DiscountService는 할인 계산 및 충성도 관리 관련 비즈니스 로직을 처리하는 서비스 클래스이다.
get_customer_discount_info(user_id, db) 함수는 특정 사용자의 충성도 할인 정보를 조회하며, 현재 주문 횟수, 할인율, 다음 등급까지 필요한 주문 횟수를 반환한다.
calculate_order_pricing(user_id, original_price, db) 함수는 주문 가격에 할인을 적용하여 최종 가격을 계산한다.
충성도 할인이 먼저 적용되고, 그 후 이벤트 할인이 누적 적용된다.
최종 할인 금액, 최종 가격, 적용된 할인 목록(충성도 할인, 이벤트 할인 정보 포함)을 반환한다.
increment_user_orders(user_id, db, total_price) 함수는 주문 완료 시 사용자의 주문 횟수를 증가시키고, 총 주문 금액을 누적한다.
apply_loyalty_discount(order_count, original_price) 함수는 주문 횟수에 따라 충성도 할인을 계산한다.
5회 이상 주문 시 5% 할인, 10회 이상 주문 시 10% 할인, 20회 이상 주문 시 15% 할인을 적용한다.
apply_event_discounts(user_id, price, db) 함수는 현재 활성화된 이벤트 중 적용 가능한 할인을 모두 찾아서 누적 적용한다.
우선순위가 높은 이벤트부터 적용되며, 할인 유형에 따라 퍼센트 또는 고정 금액 할인을 계산한다.
Database 인터페이스와 EventService에 의존하여 데이터베이스 및 이벤트 정보를 조회한다.

Database (인터페이스)

"Event & Discount Domain" 시스템의 모든 서비스는 Database 인터페이스를 통해 PostgreSQL 데이터베이스와 통신한다.
이 인터페이스는 실제로는 "Database Layer" 시스템에 구현되어 있으며, SQLAlchemy ORM을 통해 데이터베이스 작업을 수행한다.
